<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœæ ¼è¯èŒ²é­”æ³•æŒ‘æˆ°</title>
    <style>
        /* --- è¦–è¦ºæ¨£å¼ --- */
        :root {
            --primary-color: #2c241b;
            --secondary-color: #f8e7b9;
            --accent-color: #740001;
            --hogwarts-gold: #d4af37;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Times New Roman', serif, "å¾®è»Ÿæ­£é»‘é«”";
            margin: 0; padding: 0;
            background-image: url('bg_hogwarts_transparent.PNG');
            background-size: cover; background-position: center; background-attachment: fixed;
            background-color: #1a1a1a;
            height: 100vh; display: flex; overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width); background-color: rgba(30, 20, 20, 0.95);
            color: var(--secondary-color); padding: 20px; display: flex; flex-direction: column;
            align-items: center; box-shadow: 5px 0 15px rgba(0,0,0,0.8);
            border-right: 4px solid var(--accent-color); z-index: 20;
        }

        .avatar-container {
            width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--hogwarts-gold);
            overflow: hidden; margin-bottom: 20px; background-color: #fff;
            display: flex; justify-content: center; align-items: center;
        }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { text-align: center; width: 100%; }
        .player-info h2 { margin: 10px 0; font-size: 1.8em; color: var(--hogwarts-gold); text-shadow: 2px 2px 4px #000; }
        .stats-box { background: rgba(255, 255, 255, 0.1); padding: 10px; margin: 10px 0; border-radius: 8px; width: 100%; font-size: 1.2em; border: 1px solid var(--accent-color); }

        #main-content { flex: 1; padding: 30px; display: flex; justify-content: center; align-items: center; position: relative; }

        .scroll-container {
            background-color: var(--secondary-color); width: 90%; max-width: 1000px; height: 80vh;
            padding: 40px; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 10px solid transparent; border-image: url('https://i.imgur.com/wFfkI6G.png') 30 stretch;
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto;
        }

        h1.game-title { color: var(--accent-color); text-align: center; font-size: 3.5em; margin-bottom: 30px; font-weight: bold; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); }

        #character-selection { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
        .char-card { width: 220px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.4); padding: 20px; border-radius: 20px; border: 3px solid var(--primary-color); }
        .char-card:hover { transform: translateY(-15px) scale(1.05); box-shadow: 0 20px 30px rgba(0,0,0,0.4); background: #fff; border-color: var(--accent-color); }
        .char-card img { width: 100%; height: 220px; object-fit: contain; border-radius: 10px; margin-bottom: 15px; }

        #quiz-area, #win-screen { display: none; width: 100%; text-align: center; height: 100%; justify-content: center; flex-direction: column; }
        .question-text { font-size: 3.5em; color: var(--primary-color); margin-bottom: 30px; font-weight: bold; line-height: 1.5; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); font-family: 'Courier New', Courier, monospace; }
        
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; width: 90%; margin: 0 auto; }
        .option-btn, .action-btn { padding: 25px; font-size: 2em; border: 4px solid var(--primary-color); background-color: rgba(255,255,255,0.6); color: var(--primary-color); cursor: pointer; border-radius: 15px; font-family: inherit; font-weight: bold; transition: all 0.2s; box-shadow: 0 5px 0 rgba(0,0,0,0.2); }
        .option-btn:hover, .action-btn:hover { background-color: var(--primary-color); color: var(--secondary-color); transform: translateY(-5px); box-shadow: 0 10px 0 rgba(0,0,0,0.2); }
        .input-answer { padding: 20px; font-size: 2em; width: 60%; border: 4px solid var(--primary-color); border-radius: 15px; text-align: center; background: #fff; }

        .reward-image-container { position: relative; width: 70%; height: 400px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        .reward-image { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 0 30px gold); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .magic-star { position: absolute; font-size: 40px; pointer-events: none; animation: star-anim 1s ease-out forwards; z-index: 100; }
        @keyframes star-anim { 0% { opacity: 1; transform: scale(0.5) rotate(0deg); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg); } }

        /* è€å¸«å‡ºé¡Œæ¨£å¼ */
        .teacher-btn { position: absolute; top: 20px; right: 20px; background: var(--accent-color); color: #fff; border: 2px solid #fff; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #teacher-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .panel-content { background: #fff; color: #333; max-width: 1000px; margin: 0 auto; padding: 30px; border-radius: 10px; border: 5px solid var(--accent-color); }
        .level-editor { background: #f9f9f9; padding: 15px; margin-bottom: 20px; border-left: 5px solid var(--primary-color); display: flex; gap: 20px; flex-wrap: wrap;}
        .editor-input-area { flex: 2; min-width: 300px; }
        .editor-example-area { flex: 1; background: #e8f5e9; padding: 10px; border-radius: 8px; font-size: 0.9em; min-width: 250px; border: 1px solid #4caf50;}
        textarea.question-input { width: 100%; height: 120px; padding: 10px; font-family: monospace; font-size: 1.1em; border: 1px solid #ccc; border-radius: 5px; }
        .link-output-box { width: 100%; padding: 15px; background: #e0f7fa; border: 2px solid #006064; border-radius: 5px; margin-top: 15px; word-break: break-all; display: none; }
        
        .example-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .ex-code { font-family: monospace; color: #2e7d32; background: #fff; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
        .ex-desc { color: #555; }
    </style>
</head>
<body>

    <button class="teacher-btn" onclick="toggleTeacherPanel()">ğŸ“ è€å¸«å‡ºé¡Œ</button>

    <div id="sidebar">
        <div class="avatar-container">
            <img id="current-avatar" src="https://via.placeholder.com/140x140?text=?" alt="è§’è‰²">
        </div>
        <div class="player-info">
            <h2 id="player-name">è¨ªå®¢</h2>
            <div class="stats-box">é—œå¡: <span id="current-level" style="color:#ffd700">1</span></div>
            <div class="stats-box">åˆ†æ•¸: <span id="current-score" style="color:#ffd700">0</span></div>
            <div id="target-reward" style="margin-top:20px; font-size:0.9em; opacity:0.8">ç›®æ¨™ï¼šè¡›æ–¯ç†å®¶çš„é£›è»Š</div>
        </div>
    </div>

    <div id="main-content">
        <div class="scroll-container">
            <div id="start-screen">
                <h1 class="game-title">é¸æ“‡ä½ çš„å·«å¸«å¤¥ä¼´</h1>
                <div id="character-selection">
                    <div class="char-card" onclick="startGame('å“ˆåˆ©æ³¢ç‰¹', 'harry_selection.PNG')">
                        <img src="harry_selection.PNG" alt="å“ˆåˆ©æ³¢ç‰¹">
                        <h3>å“ˆåˆ©æ³¢ç‰¹</h3>
                    </div>
                    <div class="char-card" onclick="startGame('æ¦®æ©è¡›æ–¯ç†', 'ron_selection.PNG')">
                        <img src="ron_selection.PNG" alt="æ¦®æ©è¡›æ–¯ç†">
                        <h3>æ¦®æ©è¡›æ–¯ç†</h3>
                    </div>
                    <div class="char-card" onclick="startGame('å¦™éº—æ ¼è˜­å‚‘', 'hermione_selection.PNG')">
                        <img src="hermione_selection.PNG" alt="å¦™éº—æ ¼è˜­å‚‘">
                        <h3>å¦™éº—æ ¼è˜­å‚‘</h3>
                    </div>
                </div>
            </div>

            <div id="quiz-area">
                <div style="width:100%">
                    <h2 id="level-title" style="color: var(--accent-color); font-size:1.5em; margin-bottom: 20px;">é—œå¡ 1</h2>
                    <div id="question-container">
                        <p class="question-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</p>
                        <div id="options-area" class="options-grid"></div>
                    </div>
                    <p id="feedback-message" style="height:40px; font-size:1.5em; font-weight:bold; margin-top:20px;"></p>
                </div>
            </div>

            <div id="win-screen">
                <h2 style="font-size: 3em; color: var(--accent-color); margin: 0;">æŒ‘æˆ°æˆåŠŸï¼</h2>
                <p style="font-size: 1.5em; margin: 10px;">ç²å¾—é­”æ³•ç‰©å“ï¼š</p>
                <div class="reward-image-container" id="reward-container">
                    <img id="reward-img" class="reward-image" src="" alt="çå‹µ">
                </div>
                <h3 id="reward-name" style="font-size: 2.5em; color: var(--primary-color); margin: 10px 0;"></h3>
                <button class="action-btn" onclick="nextLevel()">å‰å¾€ä¸‹ä¸€é—œ â¡ï¸</button>
            </div>
        </div>
    </div>

    <div id="teacher-panel">
        <div class="panel-content">
            <h1 style="color: var(--primary-color); text-align:center;">ğŸ§™â€â™‚ï¸ éœæ ¼è¯èŒ²å‡ºé¡Œç³»çµ±</h1>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #2e7d32;">
                <h3 style="margin-top:0; color:#1b5e20;">ğŸ“– é‡è¦ï¼å‡ºé¡Œè¦å‰‡æ›´æ–°</h3>
                <p>è«‹<strong>ä¸è¦</strong>åœ¨é¡Œç›®è£¡åŠ ä¸Š <code>= ?</code> æˆ–ä¸­é–“çš„ç­‰è™Ÿï¼Œç³»çµ±æœƒè‡ªå‹•å¹«æ‚¨é¡¯ç¤ºï¼</p>
                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div style="flex:1; background:white; padding:10px; border-radius:5px;">
                        <strong>ã€æ­£ç¢ºç¯„ä¾‹ã€‘ (è«‹é€™æ¨£å¯«)</strong>
                        <p style="color:#2e7d32;"><code>2 x 1 = 2,3,4</code></p>
                        <p style="font-size:0.8em;">(ç³»çµ±æœƒè‡ªå‹•é¡¯ç¤ºæˆ 2 x 1 = ?ï¼Œä¸”ç­”æ¡ˆæ˜¯ 2)</p>
                    </div>
                    <div style="flex:1; background:#ffebee; padding:10px; border-radius:5px;">
                        <strong>ã€éŒ¯èª¤ç¯„ä¾‹ã€‘ (è«‹å‹¿æ¨¡ä»¿)</strong>
                        <p style="color:#d32f2f;"><code>2 x 1 = ? = 2,3,4</code></p>
                        <p style="font-size:0.8em;">(ä¸è¦å¤šæ‰“å•è™Ÿï¼Œå¦å‰‡é›»è…¦æœƒåˆ¤æ–·éŒ¯èª¤)</p>
                    </div>
                </div>
            </div>

            <div id="editors-container"></div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: #eee; border-radius: 10px;">
                <button class="action-btn" style="background: var(--accent-color); color: white; width: 100%;" onclick="generateShareLink()">âœ¨ ç”Ÿæˆåˆ†äº«é€£çµ âœ¨</button>
                <div id="link-result" class="link-output-box">
                    <p style="font-weight:bold; color:var(--primary-color);">è¤‡è£½ä¸‹æ–¹é€£çµå‚³çµ¦å­¸ç”Ÿï¼š</p>
                    <textarea id="share-url" style="width:100%; height:80px; font-size:1.1em;" readonly></textarea>
                    <button class="option-btn" style="padding:10px; font-size:1em; margin-top:10px;" onclick="copyLink()">è¤‡è£½é€£çµ</button>
                    <button class="option-btn" style="padding:10px; font-size:1em; margin-top:10px;" onclick="testLink()">ç›´æ¥é–‹å•Ÿæ¸¬è©¦</button>
                </div>
            </div>
            <button class="action-btn" style="margin-top:20px; width:100%" onclick="toggleTeacherPanel()">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <script>
        // --- å£“ç¸®å·¥å…· ---
        var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",compressToEncodedURIComponent:function(e){return null==e?"":LZString._compress(e,6,function(e){return LZString._keyStr.charAt(e)})},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),LZString._decompress(e.length,32,function(r){return LZString._keyStr.indexOf(e.charAt(r))}))},_compress:function(e,r,n){if(null==e)return"";var t,o,i,s={},p={},u="",c="",a="",l=2,f=3,d=2,h=[],m=0,v=0;for(i=0;i<e.length;i+=1)if(u=e.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(t=0;d>t;t++)m<<=1,v==r-1?(v=0,h.push(n(m)),m=0):v++;for(o=a.charCodeAt(0),t=0;8>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}else{for(o=1,t=0;d>t;t++)m=m<<1|o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o=0;for(o=a.charCodeAt(0),t=0;16>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}l--,0==l&&(l=Math.pow(2,d),d++),delete p[a]}else for(o=s[a],t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;l--,0==l&&(l=Math.pow(2,d),d++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(t=0;d>t;t++)m<<=1,v==r-1?(v=0,h.push(n(m)),m=0):v++;for(o=a.charCodeAt(0),t=0;8>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}else{for(o=1,t=0;d>t;t++)m=m<<1|o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o=0;for(o=a.charCodeAt(0),t=0;16>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}l--,0==l&&(l=Math.pow(2,d),d++),delete p[a]}else for(o=s[a],t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;l--,0==l&&(l=Math.pow(2,d),d++)}for(o=2,t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;for(;;){if(m<<=1,v==r-1){h.push(n(m));break}v++}return h.join("")},_decompress:function(e,r,n){var t,o,i,s,p,u,c,a=[],l=4,f=4,d=3,h="",m=[],v={val:n(0),position:r,index:1};for(t=0;3>t;t+=1)a[t]=t;for(i=0,u=Math.pow(2,2),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;switch(i){case 0:for(i=0,u=Math.pow(2,8),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;p=String.fromCharCode(i);break;case 1:for(i=0,u=Math.pow(2,16),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;p=String.fromCharCode(i);break;case 2:return""}for(a[3]=p,o=p,m.push(p);;){if(v.index>e)return"";for(i=0,u=Math.pow(2,d),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;switch(p=i){case 0:for(i=0,u=Math.pow(2,8),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;a[f++]=String.fromCharCode(i),p=f-1,l--;break;case 1:for(i=0,u=Math.pow(2,16),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;a[f++]=String.fromCharCode(i),p=f-1,l--;break;case 2:return m.join("")}if(0==l&&(l=Math.pow(2,d),d++),a[p])h=a[p];else{if(p!==f)return null;h=o+o.charAt(0)}m.push(h),a[f++]=o+h.charAt(0),l--,0==l&&(l=Math.pow(2,d),d++),o=h}}};

        const levelRewards = [
            { name: "è¡›æ–¯ç†å®¶çš„é£›è»Š", img: "reward_lv1_fordanglia.PNG" }, 
            { name: "å…‰è¼ªå…©åƒ",       img: "reward_lv2_nimbus2000.PNG" },  
            { name: "éš±å½¢æ–—ç¯·",       img: "reward_lv3_cloak.PNG" },       
            { name: "åŠ«ç›œåœ°åœ–",       img: "reward_lv4_map.PNG" },         
            { name: "é·¹é¦¬",           img: "reward_lv5_hippogriff.PNG" },  
            { name: "äººé¦¬",           img: "reward_lv6_centaur.PNG" },     
            { name: "ç¨è§’ç¸",         img: "reward_lv7_unicorn.PNG" },     
            { name: "å®¶åº­å°ç²¾éˆ(å¤šæ¯”)", img: "reward_lv8_dobby.PNG" },      
            { name: "é³³å‡°",           img: "reward_lv9_phoenix.PNG" }      
        ];

        // --- é è¨­é¡Œåº« (ä¿®æ­£å¾Œçš„è³‡æ–™ï¼šæ‹¿æ‰ä¸­é–“çš„ ? å’Œ =) ---
        let defaultQuestionBank = {
            1: [ // 2çš„ä¹˜æ³•
                "2 x 1 = 2,3,4", "2 x 2 = 4,2,6", "2 x 3 = 6,8,4", 
                "2 x 4 = 8,6,10", "2 x 5 = 10,12,8", "2 x 6 = 12,14,10", 
                "2 x 7 = 14,12,16", "2 x 8 = 16,18,14", "2 x 9 = 18,16,20"
            ],
            2: [ // 3çš„ä¹˜æ³•
                "3 x 1 = 3,2,4", "3 x 2 = 6,3,9", "3 x 3 = 9,6,12", 
                "3 x 4 = 12,9,15", "3 x 5 = 15,12,18", "3 x 6 = 18,15,21", 
                "3 x 7 = 21,18,24", "3 x 8 = 24,21,27", "3 x 9 = 27,24,30"
            ],
            3: [ // 4çš„ä¹˜æ³•
                "4 x 1 = 4,2,6", "4 x 2 = 8,4,12", "4 x 3 = 12,8,16", 
                "4 x 4 = 16,12,20", "4 x 5 = 20,16,24", "4 x 6 = 24,20,28", 
                "4 x 7 = 28,24,32", "4 x 8 = 32,28,36", "4 x 9 = 36,32,40"
            ],
            4: [ // 5çš„ä¹˜æ³•
                "5 x 1 = 5,4,6", "5 x 2 = 10,5,15", "5 x 3 = 15,10,20", 
                "5 x 4 = 20,15,25", "5 x 5 = 25,20,30", "5 x 6 = 30,25,35", 
                "5 x 7 = 35,30,40", "5 x 8 = 40,35,45", "5 x 9 = 45,40,50"
            ],
            5: [ // 6çš„ä¹˜æ³•
                "6 x 1 = 6,5,7", "6 x 2 = 12,6,18", "6 x 3 = 18,12,24", 
                "6 x 4 = 24,18,30", "6 x 5 = 30,24,36", "6 x 6 = 36,30,42", 
                "6 x 7 = 42,36,48", "6 x 8 = 48,42,54", "6 x 9 = 54,48,60"
            ],
            6: [ // 7çš„ä¹˜æ³•
                "7 x 1 = 7,6,8", "7 x 2 = 14,7,21", "7 x 3 = 21,14,28", 
                "7 x 4 = 28,21,35", "7 x 5 = 35,28,42", "7 x 6 = 42,35,49", 
                "7 x 7 = 49,42,56", "7 x 8 = 56,49,63", "7 x 9 = 63,56,70"
            ],
            7: [ // 8çš„ä¹˜æ³•
                "8 x 1 = 8,7,9", "8 x 2 = 16,8,24", "8 x 3 = 24,16,32", 
                "8 x 4 = 32,24,40", "8 x 5 = 40,32,48", "8 x 6 = 48,40,56", 
                "8 x 7 = 56,48,64", "8 x 8 = 64,56,72", "8 x 9 = 72,64,80"
            ],
            8: [ // 9çš„ä¹˜æ³•
                "9 x 1 = 9,8,10", "9 x 2 = 18,9,27", "9 x 3 = 27,18,36", 
                "9 x 4 = 36,27,45", "9 x 5 = 45,36,54", "9 x 6 = 54,45,63", 
                "9 x 7 = 63,54,72", "9 x 8 = 72,63,81", "9 x 9 = 81,72,90"
            ],
            9: [ // ç¬¬ä¹é—œ
                "9 x 9 = 81,72,64", "9 x 8 = 72,63,81", "9 x 7 = 63,56,72", 
                "8 x 9 = 72,64,80", "8 x 8 = 64,56,72", "8 x 7 = 56,49,64", 
                "7 x 7 = 49,42,56", "7 x 8 = 56,49,63", "7 x 9 = 63,54,72", 
                "6 x 9 = 54,48,60"
            ]
        };

        let questionBank = JSON.parse(JSON.stringify(defaultQuestionBank));
        let gameState = { playerName: "è¨ªå®¢", level: 1, score: 0, currentQuestionIndex: 0, questionsInCurrentLevel: [], audioCtx: null };

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const qData = urlParams.get('q');
            if (qData) {
                try {
                    const jsonStr = LZString.decompressFromEncodedURIComponent(qData);
                    if (jsonStr) questionBank = JSON.parse(jsonStr);
                } catch (e) { console.error(e); }
            }
        };

        function initTeacherPanel() {
            const container = document.getElementById('editors-container');
            container.innerHTML = "";
            levelRewards.forEach((reward, index) => {
                const level = index + 1;
                const questions = questionBank[level] ? questionBank[level].join('\n') : "";
                
                const html = `
                    <div class="level-editor">
                        <div class="editor-input-area">
                            <h3 style="margin-top:0;">ç¬¬ ${level} é—œï¼š${reward.name}</h3>
                            <textarea id="input-lv-${level}" class="question-input" placeholder="è«‹è¼¸å…¥é¡Œç›® (ä¸€è¡Œä¸€é¡Œ)...">${questions}</textarea>
                        </div>
                        <div class="editor-example-area">
                            <strong>ğŸ’¡ ç¯„ä¾‹åƒè€ƒï¼š</strong>
                            <div class="example-row">
                                <span class="ex-code">2 x 1 = 2,3,4</span>
                                <span class="ex-desc">é¸æ“‡é¡Œ</span>
                            </div>
                            <div class="example-row">
                                <span class="ex-code">2 x 1 = 2</span>
                                <span class="ex-desc">å¡«ç©ºé¡Œ</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function toggleTeacherPanel() {
            const panel = document.getElementById('teacher-panel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                initTeacherPanel();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function generateShareLink() {
            let outputObj = {};
            for(let i=1; i<=9; i++) {
                const el = document.getElementById(`input-lv-${i}`);
                if(el) {
                    const lines = el.value.split('\n').map(l => l.trim()).filter(l => l !== "");
                    if(lines.length > 0) outputObj[i] = lines;
                }
            }
            const jsonStr = JSON.stringify(outputObj);
            const compressed = LZString.compressToEncodedURIComponent(jsonStr);
            const finalUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?q=" + compressed;
            document.getElementById('share-url').value = finalUrl;
            document.getElementById('link-result').style.display = 'block';
        }

        function copyLink() {
            const copyText = document.getElementById("share-url");
            copyText.select();
            document.execCommand("copy");
            alert("é€£çµå·²è¤‡è£½ï¼");
        }

        function testLink() {
            window.location.href = document.getElementById("share-url").value;
        }

        // --- éŠæˆ²é‚è¼¯ ---
        const sidebarAvatar = document.getElementById('current-avatar');
        const sidebarName = document.getElementById('player-name');
        const sidebarLevel = document.getElementById('current-level');
        const sidebarScore = document.getElementById('current-score');
        const startScreen = document.getElementById('start-screen');
        const quizArea = document.getElementById('quiz-area');
        const winScreen = document.getElementById('win-screen');
        const questionText = document.getElementById('q-text');
        const optionsArea = document.getElementById('options-area');
        const feedbackMessage = document.getElementById('feedback-message');
        const rewardImg = document.getElementById('reward-img');
        const rewardName = document.getElementById('reward-name');
        const rewardContainer = document.getElementById('reward-container');

        function initAudio() { if (!gameState.audioCtx && (window.AudioContext || window.webkitAudioContext)) gameState.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playMagicSound() {
            if (!gameState.audioCtx) return;
            if (gameState.audioCtx.state === 'suspended') gameState.audioCtx.resume();
            const ctx = gameState.audioCtx, now = ctx.currentTime;
            [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                const osc = ctx.createOscillator(), gain = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(freq, now + i*0.1);
                gain.gain.setValueAtTime(0.05, now + i*0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.8);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(now + i*0.1); osc.stop(now + i*0.1 + 0.8);
            });
        }

        function startGame(name, avatarPath) {
            initAudio(); gameState.playerName = name; sidebarAvatar.src = avatarPath; sidebarName.textContent = gameState.playerName;
            startScreen.style.display = 'none'; quizArea.style.display = 'flex'; loadLevel(1);
        }

        function loadLevel(level) {
            gameState.level = level; gameState.currentQuestionIndex = 0; sidebarLevel.textContent = level;
            document.getElementById('level-title').textContent = `é—œå¡ ${level} - ç›®æ¨™ï¼š${levelRewards[level-1] ? levelRewards[level-1].name : "???"}`;
            document.getElementById('target-reward').textContent = `ç›®æ¨™ï¼š${levelRewards[level-1] ? levelRewards[level-1].name : "???"}`;
            const rawQuestions = questionBank[level];
            gameState.questionsInCurrentLevel = (!rawQuestions || rawQuestions.length === 0) ? [{text: "æœ¬é—œå¡é€šé", correct: "Pass", type: "input", options:[]}] : shuffleArray(rawQuestions.map(parseQuestionStr));
            if(gameState.questionsInCurrentLevel.length > 10) gameState.questionsInCurrentLevel = gameState.questionsInCurrentLevel.slice(0, 10);
            loadNextQuestion();
        }

        function parseQuestionStr(qStr) {
            const parts = qStr.split('=');
            return { text: parts[0], correct: parts[1], type: (parts.length > 2 && parts[2].trim() !== "") ? 'choice' : 'input', options: (parts.length > 2) ? shuffleArray([parts[1], ...parts[2].split(',')]) : [] };
        }

        function loadNextQuestion() {
            feedbackMessage.textContent = ''; optionsArea.innerHTML = ''; 
            if (gameState.currentQuestionIndex >= gameState.questionsInCurrentLevel.length) { levelComplete(); return; }
            const currentQ = gameState.questionsInCurrentLevel[gameState.currentQuestionIndex];
            
            // è™•ç†å¡«ç©ºåº•ç·š
            let displayText = currentQ.text.replace(/_____/g, '<span style="border-bottom: 3px solid var(--primary-color); display:inline-block; width:80px;">&nbsp;</span>');
            
            // ã€é—œéµä¿®æ”¹ã€‘æ™ºæ…§åˆ¤æ–·ï¼šå¦‚æœé¡Œç›®çœ‹èµ·ä¾†åƒæ•¸å­¸ç®—å¼ï¼Œä½†æ²’æœ‰ç­‰è™Ÿï¼Œè‡ªå‹•è£œä¸Š " = ?"
            if (!displayText.includes('=') && !displayText.includes('?')) {
                // æª¢æŸ¥æ˜¯å¦åŒ…å«æ•¸å­—å’Œé‹ç®—ç¬¦
                if (/[\d]/.test(displayText) && (displayText.includes('x') || displayText.includes('+') || displayText.includes('-'))) {
                    displayText += " = ?";
                }
            }
            
            questionText.innerHTML = displayText;

            if (currentQ.type === 'choice') {
                optionsArea.className = 'options-grid'; optionsArea.style.display = 'grid';
                currentQ.options.forEach(option => {
                    const btn = document.createElement('button'); btn.className = 'option-btn'; btn.textContent = option;
                    btn.onclick = () => checkAnswer(option, currentQ.correct); optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.className = ''; optionsArea.style.display = 'flex'; optionsArea.style.flexDirection = 'column'; optionsArea.style.alignItems = 'center';
                if(currentQ.correct === "Pass") {
                    const btn = document.createElement('button'); btn.className = 'action-btn'; btn.textContent = 'é ˜å–çå‹µ'; btn.onclick = () => checkAnswer("Pass", "Pass"); optionsArea.appendChild(btn);
                } else {
                    const input = document.createElement('input'); input.type = 'text'; input.className = 'input-answer'; input.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆ...'; input.id = 'answer-input';
                    input.onkeypress = (e) => { if(e.key === 'Enter') checkAnswer(input.value.trim(), currentQ.correct); };
                    const submitBtn = document.createElement('button'); submitBtn.className = 'action-btn'; submitBtn.textContent = 'ç¢ºèª'; submitBtn.style.marginTop = '20px';
                    submitBtn.onclick = () => checkAnswer(input.value.trim(), currentQ.correct);
                    optionsArea.appendChild(input); optionsArea.appendChild(submitBtn); input.focus();
                }
            }
        }

        function checkAnswer(userAnswer, correctAnswer) {
            if(!userAnswer && userAnswer !== 0) return;
            const buttons = optionsArea.querySelectorAll('button'); buttons.forEach(btn => btn.disabled = true);
            if(document.getElementById('answer-input')) document.getElementById('answer-input').disabled = true;
            if ((userAnswer.toLowerCase() === correctAnswer.toLowerCase()) || (correctAnswer === "Pass")) {
                feedbackMessage.innerHTML = "âœ¨ æ–½å’’æˆåŠŸï¼ç­”å°äº†ï¼ âœ¨"; feedbackMessage.style.color = "green"; playMagicSound();
                if(correctAnswer !== "Pass") { gameState.score += 10; sidebarScore.textContent = gameState.score; }
                setTimeout(() => { gameState.currentQuestionIndex++; loadNextQuestion(); }, 1000);
            } else {
                feedbackMessage.innerHTML = "ğŸ’¥ å’’èªåå½ˆï¼å†è©¦ä¸€æ¬¡ã€‚"; feedbackMessage.style.color = "#d32f2f";
                setTimeout(() => { buttons.forEach(btn => btn.disabled = false); if(document.getElementById('answer-input')) { document.getElementById('answer-input').disabled = false; document.getElementById('answer-input').focus(); } feedbackMessage.textContent = ''; }, 1500);
            }
        }

        function levelComplete() {
            quizArea.style.display = 'none'; winScreen.style.display = 'flex';
            const reward = levelRewards[gameState.level - 1];
            if (reward) { rewardImg.src = reward.img; rewardName.textContent = reward.name; playMagicSound(); createStars(); }
        }

        function nextLevel() {
            winScreen.style.display = 'none';
            if (gameState.level < 9) { quizArea.style.display = 'flex'; loadLevel(gameState.level + 1); }
            else { alert(`æ­å–œ ${gameState.playerName}ï¼ä½ å·²é€šéæ‰€æœ‰è€ƒé©—ï¼Œç¸½åˆ†ï¼š${gameState.score}`); location.href = window.location.href.split('?')[0]; }
        }

        function createStars() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const star = document.createElement('div'); star.className = 'magic-star';
                    star.textContent = ['âœ¨', 'â­', 'ğŸ’«'][Math.floor(Math.random() * 3)]; star.style.color = ['gold', '#ffd700', '#fff'][Math.floor(Math.random() * 3)];
                    const startX = (Math.random() - 0.5) * 100; const startY = (Math.random() - 0.5) * 100;
                    const tx = (Math.random() - 0.5) * 800; const ty = (Math.random() - 0.5) * 800;
                    star.style.left = `calc(50% + ${startX}px)`; star.style.top = `calc(50% + ${startY}px)`;
                    star.style.setProperty('--tx', `${tx}px`); star.style.setProperty('--ty', `${ty}px`);
                    rewardContainer.appendChild(star); setTimeout(() => star.remove(), 1000);
                }, i * 50);
            }
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    </script>
</body>
</html>
