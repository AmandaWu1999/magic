<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœæ ¼è¯èŒ²é­”æ³•æŒ‘æˆ° - æ•™å¸«å‡ºé¡Œç‰ˆ</title>
    <style>
        /* --- è¦–è¦ºæ¨£å¼è¨­å®š --- */
        :root {
            --primary-color: #2c241b; /* æ›´æ·±çš„ç¾Šçš®ç´™å¢¨è‰² */
            --secondary-color: #f8e7b9;
            --accent-color: #740001; /* è‘›ä¾†åˆ†å¤šç´… */
            --hogwarts-gold: #d4af37;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Times New Roman', serif, "å¾®è»Ÿæ­£é»‘é«”";
            margin: 0;
            padding: 0;
            background-image: url('bg_hogwarts_transparent.PNG');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #1a1a1a;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* å·¦å´é‚Šæ¬„ */
        #sidebar {
            width: var(--sidebar-width);
            background-color: rgba(30, 20, 20, 0.95);
            color: var(--secondary-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 5px 0 15px rgba(0,0,0,0.8);
            border-right: 4px solid var(--accent-color);
            z-index: 20;
        }

        .avatar-container {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid var(--hogwarts-gold);
            overflow: hidden;
            margin-bottom: 20px;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            text-align: center;
            width: 100%;
        }

        .player-info h2 {
            margin: 10px 0;
            font-size: 1.8em;
            color: var(--hogwarts-gold);
            text-shadow: 2px 2px 4px #000;
        }

        .stats-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            width: 100%;
            font-size: 1.2em;
            border: 1px solid var(--accent-color);
        }

        /* ä¸»ç•«é¢å€ */
        #main-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* ç¾Šçš®ç´™å·è»¸å®¹å™¨ */
        .scroll-container {
            background-color: var(--secondary-color);
            width: 90%;
            max-width: 1000px;
            height: 80vh;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 10px solid transparent;
            border-image: url('https://i.imgur.com/wFfkI6G.png') 30 stretch;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-y: auto; /* å…è¨±å…§å®¹éé•·æ™‚æ²å‹• */
        }

        h1.game-title {
            color: var(--accent-color);
            text-align: center;
            font-size: 3.5em;
            margin-bottom: 30px;
            font-weight: bold;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
        }

        /* è§’è‰²é¸æ“‡ */
        #character-selection {
            display: flex;
            gap: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .char-card {
            width: 220px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,255,255,0.4);
            padding: 20px;
            border-radius: 20px;
            border: 3px solid var(--primary-color);
        }

        .char-card:hover {
            transform: translateY(-15px) scale(1.05);
            box-shadow: 0 20px 30px rgba(0,0,0,0.4);
            background: #fff;
            border-color: var(--accent-color);
        }

        .char-card img {
            width: 100%;
            height: 220px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        /* ç­”é¡Œå€ */
        #quiz-area, #win-screen {
            display: none;
            width: 100%;
            text-align: center;
            height: 100%; /* å……æ»¿å·è»¸ */
            justify-content: center;
            flex-direction: column;
        }

        .question-text {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 50px;
            font-weight: bold;
            line-height: 1.5;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            width: 90%;
            margin: 0 auto;
        }

        .option-btn, .action-btn {
            padding: 25px;
            font-size: 1.6em;
            border: 4px solid var(--primary-color);
            background-color: rgba(255,255,255,0.6);
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 15px;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
        }

        .option-btn:hover, .action-btn:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
        }

        .option-btn:active, .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .input-answer {
            padding: 20px;
            font-size: 2em;
            width: 60%;
            border: 4px solid var(--primary-color);
            border-radius: 15px;
            text-align: center;
            background: #fff;
        }

        /* ç²å‹èˆ‡çå‹µ */
        .reward-image-container {
            position: relative;
            width: 70%;
            height: 400px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .reward-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 30px gold);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* é­”æ³•æ˜Ÿæ˜Ÿç‰¹æ•ˆ */
        .magic-star {
            position: absolute;
            font-size: 40px;
            pointer-events: none;
            animation: star-anim 1s ease-out forwards;
            z-index: 100;
        }

        @keyframes star-anim {
            0% { opacity: 1; transform: scale(0.5) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg); }
        }

        /* ==================== è€å¸«å‡ºé¡Œå¾Œå°æ¨£å¼ ==================== */
        .teacher-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--accent-color);
            color: #fff;
            border: 2px solid #fff;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            z-index: 50;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        #teacher-panel {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            overflow-y: auto;
            color: #fff;
            padding: 40px;
            box-sizing: border-box;
        }

        .panel-content {
            background: #fff;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
            border-radius: 10px;
            border: 5px solid var(--accent-color);
        }

        .level-editor {
            background: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
        }

        .level-editor h3 { margin-top: 0; color: var(--accent-color); }

        textarea.question-input {
            width: 100%;
            height: 120px;
            padding: 10px;
            font-family: monospace;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .code-output {
            background: #222;
            color: #0f0;
            padding: 15px;
            width: 100%;
            height: 200px;
            font-family: monospace;
            margin-top: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .help-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #2196f3;
        }
        .help-box code { background: #fff; padding: 2px 5px; font-weight: bold; color: #d32f2f; }
        
        /* éš±è—æ²è»¸ä½†å¯æ²å‹• */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #333; }
        ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 5px; }

    </style>
</head>
<body>

    <button class="teacher-btn" onclick="toggleTeacherPanel()">ğŸ“ è€å¸«å‡ºé¡Œæ¨¡å¼</button>

    <div id="sidebar">
        <div class="avatar-container">
            <img id="current-avatar" src="https://via.placeholder.com/140x140?text=?" alt="è§’è‰²">
        </div>
        <div class="player-info">
            <h2 id="player-name">è¨ªå®¢</h2>
            <div class="stats-box">é—œå¡: <span id="current-level" style="color:#ffd700">1</span></div>
            <div class="stats-box">åˆ†æ•¸: <span id="current-score" style="color:#ffd700">0</span></div>
            <div id="target-reward" style="margin-top:20px; font-size:0.9em; opacity:0.8">ç›®æ¨™ï¼šè¡›æ–¯ç†å®¶çš„é£›è»Š</div>
        </div>
    </div>

    <div id="main-content">
        <div class="scroll-container">
            
            <div id="start-screen">
                <h1 class="game-title">é¸æ“‡ä½ çš„å·«å¸«å¤¥ä¼´</h1>
                <div id="character-selection">
                    <div class="char-card" onclick="startGame('å“ˆåˆ©æ³¢ç‰¹', 'harry_selection.PNG')">
                        <img src="harry_selection.PNG" alt="å“ˆåˆ©æ³¢ç‰¹">
                        <h3>å“ˆåˆ©æ³¢ç‰¹</h3>
                    </div>
                    <div class="char-card" onclick="startGame('æ¦®æ©è¡›æ–¯ç†', 'ron_selection.PNG')">
                        <img src="ron_selection.PNG" alt="æ¦®æ©è¡›æ–¯ç†">
                        <h3>æ¦®æ©è¡›æ–¯ç†</h3>
                    </div>
                    <div class="char-card" onclick="startGame('å¦™éº—æ ¼è˜­å‚‘', 'hermione_selection.PNG')">
                        <img src="hermione_selection.PNG" alt="å¦™éº—æ ¼è˜­å‚‘">
                        <h3>å¦™éº—æ ¼è˜­å‚‘</h3>
                    </div>
                </div>
            </div>

            <div id="quiz-area">
                <div style="width:100%">
                    <h2 id="level-title" style="color: var(--accent-color); font-size:1.5em; margin-bottom: 20px;">é—œå¡ 1</h2>
                    <div id="question-container">
                        <p class="question-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</p>
                        <div id="options-area" class="options-grid"></div>
                    </div>
                    <p id="feedback-message" style="height:40px; font-size:1.5em; font-weight:bold; margin-top:20px;"></p>
                </div>
            </div>

            <div id="win-screen">
                <h2 style="font-size: 3em; color: var(--accent-color); margin: 0;">æŒ‘æˆ°æˆåŠŸï¼</h2>
                <p style="font-size: 1.5em; margin: 10px;">ç²å¾—é­”æ³•ç‰©å“ï¼š</p>
                <div class="reward-image-container" id="reward-container">
                    <img id="reward-img" class="reward-image" src="" alt="çå‹µ">
                </div>
                <h3 id="reward-name" style="font-size: 2.5em; color: var(--primary-color); margin: 10px 0;"></h3>
                <button class="action-btn" onclick="nextLevel()">å‰å¾€ä¸‹ä¸€é—œ â¡ï¸</button>
            </div>

        </div>
    </div>

    <div id="teacher-panel">
        <div class="panel-content">
            <h1 style="color: var(--primary-color); text-align:center;">ğŸ§™â€â™‚ï¸ éœæ ¼è¯èŒ²å‡ºé¡Œç³»çµ±</h1>
            
            <div class="help-box">
                <h3>ğŸ“œ å‡ºé¡Œè¦å‰‡èªªæ˜</h3>
                <p>è«‹åœ¨ä¸‹æ–¹å°æ‡‰çš„é—œå¡è¼¸å…¥é¡Œç›®ï¼Œ<strong>æ¯ä¸€è¡Œä»£è¡¨ä¸€é¡Œ</strong>ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</p>
                <ul>
                    <li><strong>é¸æ“‡é¡Œ (å‰é¢é¡Œç›®ï¼Œä¸­é–“ç­”æ¡ˆï¼Œå¾Œé¢éŒ¯èª¤é¸é …)ï¼š</strong><br>
                        <code>é¡Œç›®å…§å®¹=æ­£ç¢ºç­”æ¡ˆ=éŒ¯èª¤1,éŒ¯èª¤2,éŒ¯èª¤3</code><br>
                        <em>ç¯„ä¾‹ï¼š</em> <code>æˆ‘å¾ˆå–œæ­¡___å®¶äººä¸€èµ·çœ‹é›»å½±=è·Ÿ=çµ¦,å°,å‘</code>
                    </li>
                    <li><strong>å•ç­”/å¡«ç©º/æ•¸å­¸é¡Œ (ç„¡é¸é …)ï¼š</strong><br>
                        <code>é¡Œç›®å…§å®¹=æ­£ç¢ºç­”æ¡ˆ</code><br>
                        <em>ç¯„ä¾‹ï¼š</em> <code>9x9=?=81</code><br>
                        <em>ç¯„ä¾‹ï¼š</em> <code>ä¸­æ–‡æ‹¼éŸ³: ä¸­æ–‡=zhÅngwÃ©n</code>
                    </li>
                </ul>
                <p>â€» è€å¸«æ¯å€‹é—œå¡å¯ä»¥è¼¸å…¥ 1 åˆ° 10 é¡Œï¼Œç³»çµ±æœƒéš¨æ©Ÿå‡ºé¡Œã€‚</p>
            </div>

            <div id="editors-container">
                </div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: #eee; border-radius: 10px;">
                <h2 style="color: #d32f2f;">âš ï¸ å„²å­˜æ­¥é©Ÿ (éå¸¸é‡è¦)</h2>
                <button class="action-btn" style="background: var(--accent-color); color: white;" onclick="generateConfigCode()">1. é»æ­¤ç”Ÿæˆç¨‹å¼ç¢¼</button>
                <br><br>
                <p>2. ç”Ÿæˆå¾Œï¼Œè«‹å…¨é¸ä¸¦è¤‡è£½ä¸‹æ–¹é»‘æ¡†å…§çš„ä»£ç¢¼ã€‚</p>
                <p>3. å›åˆ° GitHub ç·¨è¼¯ <code>index.html</code>ï¼Œæ‰¾åˆ°æœ€ä¸‹æ–¹çš„ <code>let questionBank = ...</code> å€å¡Šï¼Œå°‡å…¶æ›¿æ›ã€‚</p>
                <textarea id="output-code" class="code-output" readonly placeholder="é»æ“ŠæŒ‰éˆ•å¾Œï¼Œç¨‹å¼ç¢¼æœƒå‡ºç¾åœ¨é€™è£¡..."></textarea>
            </div>

            <button class="action-btn" style="margin-top:20px; width:100%" onclick="toggleTeacherPanel()">é—œé–‰å‡ºé¡Œè¦–çª—</button>
        </div>
    </div>

    <script>
        // --- é—œå¡èˆ‡çå‹µè¨­å®š ---
        const levelRewards = [
            { name: "è¡›æ–¯ç†å®¶çš„é£›è»Š", img: "reward_lv1_fordanglia.PNG" }, 
            { name: "å…‰è¼ªå…©åƒ",       img: "reward_lv2_nimbus2000.PNG" },  
            { name: "éš±å½¢æ–—ç¯·",       img: "reward_lv3_cloak.PNG" },       
            { name: "åŠ«ç›œåœ°åœ–",       img: "reward_lv4_map.PNG" },         
            { name: "é·¹é¦¬",           img: "reward_lv5_hippogriff.PNG" },  
            { name: "äººé¦¬",           img: "reward_lv6_centaur.PNG" },     
            { name: "ç¨è§’ç¸",         img: "reward_lv7_unicorn.PNG" },     
            { name: "å®¶åº­å°ç²¾éˆ(å¤šæ¯”)", img: "reward_lv8_dobby.PNG" },      
            { name: "é³³å‡°",           img: "reward_lv9_phoenix.PNG" }      
        ];

        // =========================================================================
        // â–¼â–¼â–¼ è€å¸«å‡ºé¡Œå€ (é€™è£¡å°±æ˜¯ä½ è¦æ›¿æ›çš„åœ°æ–¹) â–¼â–¼â–¼
        let questionBank = {
            1: [
                "9x9=?=81",
                "ä¸­æ–‡=zhÅngwÃ©n",
                "æˆ‘å¾ˆå–œæ­¡___å®¶äººä¸€èµ·çœ‹é›»å½±=è·Ÿ=çµ¦,å°,å‘"
            ],
            2: ["2+2=?=4"],
            3: ["3+3=?=6"],
            4: ["4+4=?=8"],
            5: ["5+5=?=10"],
            6: ["6+6=?=12"],
            7: ["7+7=?=14"],
            8: ["8+8=?=16"],
            9: ["9+9=?=18"]
        };
        // â–²â–²â–² è€å¸«å‡ºé¡Œå€çµæŸ â–²â–²â–²
        // =========================================================================

        let gameState = {
            playerName: "è¨ªå®¢",
            level: 1,
            score: 0,
            currentQuestionIndex: 0,
            questionsInCurrentLevel: [],
            audioCtx: null 
        };

        const sidebarAvatar = document.getElementById('current-avatar');
        const sidebarName = document.getElementById('player-name');
        const sidebarLevel = document.getElementById('current-level');
        const sidebarScore = document.getElementById('current-score');
        const targetRewardLabel = document.getElementById('target-reward');
        
        const startScreen = document.getElementById('start-screen');
        const quizArea = document.getElementById('quiz-area');
        const winScreen = document.getElementById('win-screen');
        
        const questionText = document.getElementById('q-text');
        const optionsArea = document.getElementById('options-area');
        const feedbackMessage = document.getElementById('feedback-message');
        
        const rewardImg = document.getElementById('reward-img');
        const rewardName = document.getElementById('reward-name');
        const rewardContainer = document.getElementById('reward-container');

        // --- åˆå§‹åŒ–è€å¸«å¾Œå°ä»‹é¢ ---
        function initTeacherPanel() {
            const container = document.getElementById('editors-container');
            container.innerHTML = "";
            levelRewards.forEach((reward, index) => {
                const level = index + 1;
                const questions = questionBank[level] ? questionBank[level].join('\n') : "";
                
                const html = `
                    <div class="level-editor">
                        <h3>ç¬¬ ${level} é—œï¼š${reward.name}</h3>
                        <textarea id="input-lv-${level}" class="question-input" placeholder="è«‹è¼¸å…¥é¡Œç›®...">${questions}</textarea>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function toggleTeacherPanel() {
            const panel = document.getElementById('teacher-panel');
            if(panel.style.display === 'block') {
                panel.style.display = 'none';
            } else {
                initTeacherPanel(); // æ‰“é–‹æ™‚é‡æ–°è®€å–ç›®å‰é¡Œç›®
                panel.style.display = 'block';
            }
        }

        // --- ç”Ÿæˆä»£ç¢¼åŠŸèƒ½ ---
        function generateConfigCode() {
            let outputObj = {};
            for(let i=1; i<=9; i++) {
                const rawText = document.getElementById(`input-lv-${i}`).value;
                // éæ¿¾ç©ºè¡Œ
                const lines = rawText.split('\n').map(l => l.trim()).filter(l => l !== "");
                if(lines.length > 0) {
                    outputObj[i] = lines;
                }
            }

            const jsonStr = JSON.stringify(outputObj, null, 4);
            const finalCode = `let questionBank = ${jsonStr};`;
            
            document.getElementById('output-code').value = finalCode;
            document.getElementById('output-code').select();
            // å˜—è©¦è‡ªå‹•è¤‡è£½
            try {
                document.execCommand('copy');
                alert("ä»£ç¢¼å·²ç”Ÿæˆä¸¦è¤‡è£½ï¼è«‹å› GitHub è²¼ä¸Šã€‚");
            } catch (err) {
                alert("ä»£ç¢¼å·²ç”Ÿæˆï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹é»‘æ¡†å…§å®¹ã€‚");
            }
        }

        // --- éŸ³æ•ˆåŠŸèƒ½ ---
        function initAudio() {
            if (!gameState.audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) gameState.audioCtx = new AudioContext();
            }
        }

        function playMagicSound() {
            if (!gameState.audioCtx) return;
            if (gameState.audioCtx.state === 'suspended') gameState.audioCtx.resume();
            const ctx = gameState.audioCtx;
            const now = ctx.currentTime;
            
            // é­”æ³•éŸ³æ•ˆ (æ˜Ÿæ˜Ÿé–ƒçˆæ„Ÿ)
            [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(freq, now + i*0.1);
                
                gain.gain.setValueAtTime(0.05, now + i*0.1);
                gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.8);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(now + i*0.1);
                osc.stop(now + i*0.1 + 0.8);
            });
        }

        // --- éŠæˆ²æµç¨‹ ---
        function startGame(name, avatarPath) {
            initAudio();
            gameState.playerName = name;
            sidebarAvatar.src = avatarPath;
            sidebarName.textContent = gameState.playerName;
            
            startScreen.style.display = 'none';
            quizArea.style.display = 'flex'; // ä½¿ç”¨ flex è®“å…§å®¹ç½®ä¸­
            loadLevel(1);
        }

        function loadLevel(level) {
            gameState.level = level;
            gameState.currentQuestionIndex = 0;
            sidebarLevel.textContent = level;
            
            const rewardNameText = levelRewards[level-1] ? levelRewards[level-1].name : "???";
            targetRewardLabel.textContent = `ç›®æ¨™ï¼š${rewardNameText}`;
            document.getElementById('level-title').textContent = `é—œå¡ ${level} - æŒ‘æˆ°ç›®æ¨™ï¼š${rewardNameText}`;

            // å¾é¡Œåº«è®€å–ï¼Œå¦‚æœæ²’æœ‰å°±çµ¦é è¨­
            const rawQuestions = questionBank[level];
            if(!rawQuestions || rawQuestions.length === 0) {
                gameState.questionsInCurrentLevel = [{text: "æœ¬é—œå¡è€å¸«å°šæœªå‡ºé¡Œï¼Œé»æ“Šç¢ºèªé€šé—œ", correct: "Pass", type: "input", options:[]}];
            } else {
                gameState.questionsInCurrentLevel = rawQuestions.map(parseQuestionStr);
                // éš¨æ©Ÿæ‰“äº‚é¡Œç›®é †åº (è®“æ¯æ¬¡ç©éƒ½ä¸ä¸€æ¨£)
                gameState.questionsInCurrentLevel = shuffleArray(gameState.questionsInCurrentLevel);
            }
            
            // å¦‚æœè€å¸«å‡ºè¶…é10é¡Œï¼Œåªå–å‰10é¡Œ
            if(gameState.questionsInCurrentLevel.length > 10) {
                gameState.questionsInCurrentLevel = gameState.questionsInCurrentLevel.slice(0, 10);
            }

            loadNextQuestion();
        }

        function parseQuestionStr(qStr) {
            const parts = qStr.split('=');
            const qText = parts[0];
            const correctAnswer = parts[1];
            let type = 'input'; 
            let options = [];

            if (parts.length > 2 && parts[2].trim() !== "") {
                type = 'choice';
                const wrongAnswers = parts[2].split(',');
                options = [correctAnswer, ...wrongAnswers];
                options = shuffleArray(options);
            }
            return { text: qText, correct: correctAnswer, type: type, options: options };
        }

        function loadNextQuestion() {
            feedbackMessage.textContent = '';
            optionsArea.innerHTML = ''; 

            if (gameState.currentQuestionIndex >= gameState.questionsInCurrentLevel.length) {
                levelComplete();
                return;
            }

            const currentQ = gameState.questionsInCurrentLevel[gameState.currentQuestionIndex];
            
            // è™•ç†å¡«ç©ºåº•ç·šé¡¯ç¤º
            let displayText = currentQ.text.replace(/___/g, '<span style="border-bottom: 3px solid var(--primary-color); display:inline-block; width:80px;">&nbsp;</span>');
            questionText.innerHTML = displayText;

            if (currentQ.type === 'choice') {
                optionsArea.className = 'options-grid';
                optionsArea.style.display = 'grid';
                currentQ.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option;
                    btn.onclick = () => checkAnswer(option, currentQ.correct);
                    optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.className = '';
                optionsArea.style.display = 'flex';
                optionsArea.style.flexDirection = 'column';
                optionsArea.style.alignItems = 'center';
                
                // å¦‚æœæ˜¯ Pass é¡Œ (è€å¸«æ²’å‡ºé¡Œ)
                if(currentQ.correct === "Pass") {
                    const btn = document.createElement('button');
                    btn.className = 'action-btn';
                    btn.textContent = 'é ˜å–çå‹µ';
                    btn.onclick = () => checkAnswer("Pass", "Pass");
                    optionsArea.appendChild(btn);
                } else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'input-answer';
                    input.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆ...';
                    input.id = 'answer-input';
                    input.onkeypress = (e) => { if(e.key === 'Enter') checkAnswer(input.value.trim(), currentQ.correct); };
                    
                    const submitBtn = document.createElement('button');
                    submitBtn.className = 'action-btn';
                    submitBtn.textContent = 'ç¢ºèªå’’èª';
                    submitBtn.style.marginTop = '20px';
                    submitBtn.onclick = () => checkAnswer(input.value.trim(), currentQ.correct);

                    optionsArea.appendChild(input);
                    optionsArea.appendChild(submitBtn);
                    input.focus();
                }
            }
        }

        function checkAnswer(userAnswer, correctAnswer) {
            if(!userAnswer && userAnswer !== 0) return;
            
            // é–å®šè¼¸å…¥
            const buttons = optionsArea.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            if(document.getElementById('answer-input')) document.getElementById('answer-input').disabled = true;

            const isCorrect = (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) || (correctAnswer === "Pass");

            if (isCorrect) {
                feedbackMessage.innerHTML = "âœ¨ æ–½å’’æˆåŠŸï¼ç­”å°äº†ï¼ âœ¨";
                feedbackMessage.style.color = "green";
                playMagicSound(); // ç­”å°ä¹Ÿæœ‰å°éŸ³æ•ˆ
                
                if(correctAnswer !== "Pass") {
                    gameState.score += 10;
                    // æ›´æ–°åˆ†æ•¸å‹•ç•«
                    sidebarScore.style.transform = "scale(1.5)";
                    setTimeout(()=> sidebarScore.style.transform = "scale(1)", 200);
                }
                sidebarScore.textContent = gameState.score;
                
                setTimeout(() => {
                    gameState.currentQuestionIndex++;
                    loadNextQuestion();
                }, 1000);
            } else {
                feedbackMessage.innerHTML = "ğŸ’¥ å’’èªåå½ˆï¼å†è©¦ä¸€æ¬¡ã€‚";
                feedbackMessage.style.color = "#d32f2f";
                // éœ‡å‹•ç‰¹æ•ˆ
                document.querySelector('.scroll-container').style.transform = "translateX(10px)";
                setTimeout(()=> document.querySelector('.scroll-container').style.transform = "translateX(0)", 100);
                setTimeout(()=> document.querySelector('.scroll-container').style.transform = "translateX(-10px)", 200);
                setTimeout(()=> document.querySelector('.scroll-container').style.transform = "translateX(0)", 300);

                setTimeout(() => {
                     buttons.forEach(btn => btn.disabled = false);
                     if(document.getElementById('answer-input')) {
                         document.getElementById('answer-input').disabled = false;
                         document.getElementById('answer-input').focus();
                     }
                     feedbackMessage.textContent = '';
                }, 1500);
            }
        }

        function levelComplete() {
            quizArea.style.display = 'none';
            winScreen.style.display = 'flex'; // æ”¹ç‚º flex ç¢ºä¿ç½®ä¸­
            
            const rewardIndex = gameState.level - 1;
            if (rewardIndex < levelRewards.length) {
                const reward = levelRewards[rewardIndex];
                rewardImg.src = reward.img;
                rewardName.textContent = reward.name;
                
                // æ’­æ”¾éé—œéŸ³æ•ˆèˆ‡ç‰¹æ•ˆ
                playMagicSound();
                createStars();
            }
        }

        function nextLevel() {
            winScreen.style.display = 'none';
            if (gameState.level < 9) {
                quizArea.style.display = 'flex';
                loadLevel(gameState.level + 1);
            } else {
                alert(`æ­å–œ ${gameState.playerName}ï¼ä½ å·²é€šéæ‰€æœ‰éœæ ¼è¯èŒ²çš„è€ƒé©—ï¼Œæˆç‚ºä¸€åå‰å¤§çš„å·«å¸«ï¼ç¸½åˆ†ï¼š${gameState.score}`);
                location.reload();
            }
        }

        function createStars() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'magic-star';
                    star.textContent = ['âœ¨', 'â­', 'ğŸ’«'][Math.floor(Math.random() * 3)];
                    star.style.color = ['gold', '#ffd700', '#fff', '#e0ffff'][Math.floor(Math.random() * 4)];
                    
                    // éš¨æ©Ÿç™¼å°„ä½ç½®
                    const startX = (Math.random() - 0.5) * 100;
                    const startY = (Math.random() - 0.5) * 100;
                    const tx = (Math.random() - 0.5) * 800; // æ“´æ•£ç¯„åœ
                    const ty = (Math.random() - 0.5) * 800;

                    star.style.left = `calc(50% + ${startX}px)`;
                    star.style.top = `calc(50% + ${startY}px)`;
                    star.style.setProperty('--tx', `${tx}px`);
                    star.style.setProperty('--ty', `${ty}px`);

                    rewardContainer.appendChild(star);
                    setTimeout(() => star.remove(), 1000);
                }, i * 50);
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
