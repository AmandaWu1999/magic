<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœæ ¼è¯èŒ²é­”æ³•æŒ‘æˆ°</title>
    <style>
        /* --- è¦–è¦ºæ¨£å¼ --- */
        :root {
            --primary-color: #2c241b;
            --secondary-color: #f8e7b9;
            --accent-color: #740001;
            --hogwarts-gold: #d4af37;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Times New Roman', "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            margin: 0; padding: 0;
            background-image: url('bg_hogwarts_transparent.PNG');
            background-size: cover; background-position: center; background-attachment: fixed;
            background-color: #1a1a1a;
            height: 100vh; display: flex; overflow: hidden;
        }

        #sidebar {
            width: var(--sidebar-width); background-color: rgba(30, 20, 20, 0.95);
            color: var(--secondary-color); padding: 20px; display: flex; flex-direction: column;
            align-items: center; box-shadow: 5px 0 15px rgba(0,0,0,0.8);
            border-right: 4px solid var(--accent-color); z-index: 20;
        }

        .avatar-container {
            width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--hogwarts-gold);
            overflow: hidden; margin-bottom: 20px; background-color: #fff;
            display: flex; justify-content: center; align-items: center;
        }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { text-align: center; width: 100%; }
        .player-info h2 { margin: 10px 0; font-size: 1.8em; color: var(--hogwarts-gold); text-shadow: 2px 2px 4px #000; }
        .stats-box { background: rgba(255, 255, 255, 0.1); padding: 10px; margin: 10px 0; border-radius: 8px; width: 100%; font-size: 1.2em; border: 1px solid var(--accent-color); }

        #main-content { flex: 1; padding: 30px; display: flex; justify-content: center; align-items: center; position: relative; }

        .scroll-container {
            background-color: var(--secondary-color); width: 90%; max-width: 1000px; height: 80vh;
            padding: 40px; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 10px solid transparent; border-image: url('https://i.imgur.com/wFfkI6G.png') 30 stretch;
            position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto;
        }

        h1.game-title { color: var(--accent-color); text-align: center; font-size: 3.5em; margin-bottom: 30px; font-weight: bold; text-shadow: 1px 1px 0px rgba(0,0,0,0.3); }

        #character-selection { display: flex; gap: 40px; justify-content: center; flex-wrap: wrap; }
        .char-card { width: 220px; text-align: center; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.4); padding: 20px; border-radius: 20px; border: 3px solid var(--primary-color); }
        .char-card:hover { transform: translateY(-15px) scale(1.05); box-shadow: 0 20px 30px rgba(0,0,0,0.4); background: #fff; border-color: var(--accent-color); }
        .char-card img { width: 100%; height: 220px; object-fit: contain; border-radius: 10px; margin-bottom: 15px; }

        #quiz-area, #win-screen { display: none; width: 100%; text-align: center; height: 100%; justify-content: center; flex-direction: column; }
        .question-text { font-size: 3em; color: var(--primary-color); margin-bottom: 30px; font-weight: bold; line-height: 1.5; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); font-family: 'Courier New', Courier, monospace; }
        
        .options-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; width: 90%; margin: 0 auto; }
        .option-btn, .action-btn { padding: 25px; font-size: 2em; border: 4px solid var(--primary-color); background-color: rgba(255,255,255,0.6); color: var(--primary-color); cursor: pointer; border-radius: 15px; font-family: inherit; font-weight: bold; transition: all 0.2s; box-shadow: 0 5px 0 rgba(0,0,0,0.2); }
        .option-btn:hover, .action-btn:hover { background-color: var(--primary-color); color: var(--secondary-color); transform: translateY(-5px); box-shadow: 0 10px 0 rgba(0,0,0,0.2); }
        .input-answer { padding: 20px; font-size: 2em; width: 60%; border: 4px solid var(--primary-color); border-radius: 15px; text-align: center; background: #fff; }

        .reward-image-container { position: relative; width: 70%; height: 400px; margin: 20px auto; display: flex; justify-content: center; align-items: center; }
        .reward-image { max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 0 30px gold); animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .magic-star { position: absolute; font-size: 40px; pointer-events: none; animation: star-anim 1s ease-out forwards; z-index: 100; }
        @keyframes star-anim { 0% { opacity: 1; transform: scale(0.5) rotate(0deg); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg); } }

        /* --- è€å¸«å‡ºé¡Œä»‹é¢ (Google Form é¢¨æ ¼) --- */
        .teacher-btn { position: absolute; top: 20px; right: 20px; background: var(--accent-color); color: #fff; border: 2px solid #fff; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #teacher-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .panel-content { background: #f0f2f5; color: #333; max-width: 900px; margin: 0 auto; padding: 40px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        .level-section { background: #fff; border-radius: 8px; margin-bottom: 20px; padding: 20px; border-left: 6px solid var(--accent-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .level-title { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .level-title h3 { margin: 0; color: var(--primary-color); }
        .toggle-icon { font-weight: bold; font-size: 1.2em; }
        
        .question-card { background: #fafafa; border: 1px solid #ddd; padding: 15px; margin-top: 15px; border-radius: 8px; position: relative; }
        .question-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .form-control { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-add { background: #2e7d32; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
        .btn-del { background: #c62828; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        
        .collapsed .questions-container { display: none; }
    </style>
</head>
<body>

    <button class="teacher-btn" onclick="toggleTeacherPanel()">ğŸ“ è€å¸«å‡ºé¡Œ</button>

    <div id="sidebar">
        <div class="avatar-container">
            <img id="current-avatar" src="https://via.placeholder.com/140x140?text=?" alt="è§’è‰²">
        </div>
        <div class="player-info">
            <h2 id="player-name">è¨ªå®¢</h2>
            <div class="stats-box">é—œå¡: <span id="current-level" style="color:#ffd700">1</span></div>
            <div class="stats-box">åˆ†æ•¸: <span id="current-score" style="color:#ffd700">0</span></div>
            <div id="target-reward" style="margin-top:20px; font-size:0.9em; opacity:0.8">ç›®æ¨™ï¼šè¡›æ–¯ç†å®¶çš„é£›è»Š</div>
        </div>
    </div>

    <div id="main-content">
        <div class="scroll-container">
            <div id="start-screen">
                <h1 class="game-title">é¸æ“‡ä½ çš„å·«å¸«å¤¥ä¼´</h1>
                <div id="character-selection">
                    <div class="char-card" onclick="startGame('å“ˆåˆ©æ³¢ç‰¹', 'harry_selection.PNG')">
                        <img src="harry_selection.PNG" alt="å“ˆåˆ©æ³¢ç‰¹">
                        <h3>å“ˆåˆ©æ³¢ç‰¹</h3>
                    </div>
                    <div class="char-card" onclick="startGame('æ¦®æ©è¡›æ–¯ç†', 'ron_selection.PNG')">
                        <img src="ron_selection.PNG" alt="æ¦®æ©è¡›æ–¯ç†">
                        <h3>æ¦®æ©è¡›æ–¯ç†</h3>
                    </div>
                    <div class="char-card" onclick="startGame('å¦™éº—æ ¼è˜­å‚‘', 'hermione_selection.PNG')">
                        <img src="hermione_selection.PNG" alt="å¦™éº—æ ¼è˜­å‚‘">
                        <h3>å¦™éº—æ ¼è˜­å‚‘</h3>
                    </div>
                </div>
            </div>

            <div id="quiz-area">
                <div style="width:100%">
                    <h2 id="level-title" style="color: var(--accent-color); font-size:1.5em; margin-bottom: 20px;">é—œå¡ 1</h2>
                    <div id="question-container">
                        <p class="question-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</p>
                        <div id="options-area" class="options-grid"></div>
                    </div>
                    <p id="feedback-message" style="height:40px; font-size:1.5em; font-weight:bold; margin-top:20px;"></p>
                </div>
            </div>

            <div id="win-screen">
                <h2 style="font-size: 3em; color: var(--accent-color); margin: 0;">æŒ‘æˆ°æˆåŠŸï¼</h2>
                <p style="font-size: 1.5em; margin: 10px;">ç²å¾—é­”æ³•ç‰©å“ï¼š</p>
                <div class="reward-image-container" id="reward-container">
                    <img id="reward-img" class="reward-image" src="" alt="çå‹µ">
                </div>
                <h3 id="reward-name" style="font-size: 2.5em; color: var(--primary-color); margin: 10px 0;"></h3>
                <button class="action-btn" onclick="nextLevel()">å‰å¾€ä¸‹ä¸€é—œ â¡ï¸</button>
            </div>
        </div>
    </div>

    <div id="teacher-panel">
        <div class="panel-content">
            <h1 style="text-align:center; color: var(--primary-color);">ğŸ“ éœæ ¼è¯èŒ²å‡ºé¡Œè¡¨å–®</h1>
            <p style="text-align:center; color: #666;">åƒ Google è¡¨å–®ä¸€æ¨£è¨­è¨ˆé¡Œç›®ï¼Œå†ä¹Ÿä¸ç”¨æ“”å¿ƒæ ¼å¼éŒ¯èª¤ï¼</p>
            
            <div id="form-container"></div>

            <div style="text-align: center; margin-top: 30px; padding: 20px; background: #fff; border-radius: 10px; border: 1px solid #ddd;">
                <button class="action-btn" style="background: var(--accent-color); color: white; width: 100%;" onclick="generateShareLink()">âœ¨ ç”Ÿæˆåˆ†äº«é€£çµ âœ¨</button>
                <div id="link-result" style="display:none; margin-top: 15px;">
                    <p style="font-weight:bold;">è¤‡è£½ä¸‹æ–¹é€£çµå‚³çµ¦å­¸ç”Ÿï¼š</p>
                    <textarea id="share-url" style="width:100%; height:80px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;" readonly></textarea>
                    <div style="margin-top: 10px;">
                        <button class="btn-add" onclick="copyLink()">è¤‡è£½é€£çµ</button>
                        <button class="btn-add" style="background: #1976d2;" onclick="testLink()">æ¸¬è©¦é€£çµ</button>
                    </div>
                </div>
            </div>
            <button class="action-btn" style="margin-top:20px; width:100%; background: #666;" onclick="toggleTeacherPanel()">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <script>
        // --- LZString å£“ç¸® ---
        var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",compressToEncodedURIComponent:function(e){return null==e?"":LZString._compress(e,6,function(e){return LZString._keyStr.charAt(e)})},decompressFromEncodedURIComponent:function(e){return null==e?"":""==e?null:(e=e.replace(/ /g,"+"),LZString._decompress(e.length,32,function(r){return LZString._keyStr.indexOf(e.charAt(r))}))},_compress:function(e,r,n){if(null==e)return"";var t,o,i,s={},p={},u="",c="",a="",l=2,f=3,d=2,h=[],m=0,v=0;for(i=0;i<e.length;i+=1)if(u=e.charAt(i),Object.prototype.hasOwnProperty.call(s,u)||(s[u]=f++,p[u]=!0),c=a+u,Object.prototype.hasOwnProperty.call(s,c))a=c;else{if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(t=0;d>t;t++)m<<=1,v==r-1?(v=0,h.push(n(m)),m=0):v++;for(o=a.charCodeAt(0),t=0;8>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}else{for(o=1,t=0;d>t;t++)m=m<<1|o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o=0;for(o=a.charCodeAt(0),t=0;16>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}l--,0==l&&(l=Math.pow(2,d),d++),delete p[a]}else for(o=s[a],t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;l--,0==l&&(l=Math.pow(2,d),d++),s[c]=f++,a=String(u)}if(""!==a){if(Object.prototype.hasOwnProperty.call(p,a)){if(a.charCodeAt(0)<256){for(t=0;d>t;t++)m<<=1,v==r-1?(v=0,h.push(n(m)),m=0):v++;for(o=a.charCodeAt(0),t=0;8>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}else{for(o=1,t=0;d>t;t++)m=m<<1|o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o=0;for(o=a.charCodeAt(0),t=0;16>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1}l--,0==l&&(l=Math.pow(2,d),d++),delete p[a]}else for(o=s[a],t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;l--,0==l&&(l=Math.pow(2,d),d++)}for(o=2,t=0;d>t;t++)m=m<<1|1&o,v==r-1?(v=0,h.push(n(m)),m=0):v++,o>>=1;for(;;){if(m<<=1,v==r-1){h.push(n(m));break}v++}return h.join("")},_decompress:function(e,r,n){var t,o,i,s,p,u,c,a=[],l=4,f=4,d=3,h="",m=[],v={val:n(0),position:r,index:1};for(t=0;3>t;t+=1)a[t]=t;for(i=0,u=Math.pow(2,2),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;switch(i){case 0:for(i=0,u=Math.pow(2,8),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;p=String.fromCharCode(i);break;case 1:for(i=0,u=Math.pow(2,16),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;p=String.fromCharCode(i);break;case 2:return""}for(a[3]=p,o=p,m.push(p);;){if(v.index>e)return"";for(i=0,u=Math.pow(2,d),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;switch(p=i){case 0:for(i=0,u=Math.pow(2,8),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;a[f++]=String.fromCharCode(i),p=f-1,l--;break;case 1:for(i=0,u=Math.pow(2,16),c=1;u!=c;)s=v.val&v.position,v.position>>=1,0==v.position&&(v.position=r,v.val=n(v.index++)),i|=(s>0?1:0)*c,c<<=1;a[f++]=String.fromCharCode(i),p=f-1,l--;break;case 2:return m.join("")}if(0==l&&(l=Math.pow(2,d),d++),a[p])h=a[p];else{if(p!==f)return null;h=o+o.charAt(0)}m.push(h),a[f++]=o+h.charAt(0),l--,0==l&&(l=Math.pow(2,d),d++),o=h}}};

        const levelRewards = [
            { name: "è¡›æ–¯ç†å®¶çš„é£›è»Š", img: "reward_lv1_fordanglia.PNG" }, 
            { name: "å…‰è¼ªå…©åƒ",       img: "reward_lv2_nimbus2000.PNG" },  
            { name: "éš±å½¢æ–—ç¯·",       img: "reward_lv3_cloak.PNG" },       
            { name: "åŠ«ç›œåœ°åœ–",       img: "reward_lv4_map.PNG" },         
            { name: "é·¹é¦¬",           img: "reward_lv5_hippogriff.PNG" },  
            { name: "äººé¦¬",           img: "reward_lv6_centaur.PNG" },     
            { name: "ç¨è§’ç¸",         img: "reward_lv7_unicorn.PNG" },     
            { name: "å®¶åº­å°ç²¾éˆ(å¤šæ¯”)", img: "reward_lv8_dobby.PNG" },      
            { name: "é³³å‡°",           img: "reward_lv9_phoenix.PNG" }      
        ];

        // --- é è¨­é¡Œåº« (ä¹ä¹ä¹˜æ³• - ä½¿ç”¨æ–°çµæ§‹) ---
        // çµæ§‹: { 1: [ {q:"2x2=?", a:"4", type:"input"}, ... ] }
        let defaultQuestionBank = {
            1: Array.from({length:9}, (_,i)=>({q:`2 x ${i+1} = ?`, a:`${2*(i+1)}`, type:"choice", opts:[`${2*(i+1)}`, `${2*(i+1)+1}`, `${2*(i+1)-1}`]})),
            2: Array.from({length:9}, (_,i)=>({q:`3 x ${i+1} = ?`, a:`${3*(i+1)}`, type:"choice", opts:[`${3*(i+1)}`, `${3*(i+1)+1}`, `${3*(i+1)-1}`]})),
            3: Array.from({length:9}, (_,i)=>({q:`4 x ${i+1} = ?`, a:`${4*(i+1)}`, type:"choice", opts:[`${4*(i+1)}`, `${4*(i+1)+2}`, `${4*(i+1)-2}`]})),
            4: Array.from({length:9}, (_,i)=>({q:`5 x ${i+1} = ?`, a:`${5*(i+1)}`, type:"choice", opts:[`${5*(i+1)}`, `${5*(i+1)+1}`, `${5*(i+1)+2}`]})),
            5: Array.from({length:9}, (_,i)=>({q:`6 x ${i+1} = ?`, a:`${6*(i+1)}`, type:"choice", opts:[`${6*(i+1)}`, `${6*(i+1)+3}`, `${6*(i+1)-3}`]})),
            6: Array.from({length:9}, (_,i)=>({q:`7 x ${i+1} = ?`, a:`${7*(i+1)}`, type:"choice", opts:[`${7*(i+1)}`, `${7*(i+1)+2}`, `${7*(i+1)-2}`]})),
            7: Array.from({length:9}, (_,i)=>({q:`8 x ${i+1} = ?`, a:`${8*(i+1)}`, type:"choice", opts:[`${8*(i+1)}`, `${8*(i+1)+4}`, `${8*(i+1)-4}`]})),
            8: Array.from({length:9}, (_,i)=>({q:`9 x ${i+1} = ?`, a:`${9*(i+1)}`, type:"choice", opts:[`${9*(i+1)}`, `${9*(i+1)+5}`, `${9*(i+1)-5}`]})),
            9: Array.from({length:9}, (_,i)=>({q:`9 x ${9-i} = ?`, a:`${9*(9-i)}`, type:"choice", opts:[`${9*(9-i)}`, `${9*(9-i)+9}`, `${9*(9-i)-9}`]}))
        };

        let questionBank = JSON.parse(JSON.stringify(defaultQuestionBank));
        let gameState = { playerName: "è¨ªå®¢", level: 1, score: 0, currentQuestionIndex: 0, questionsInCurrentLevel: [], audioCtx: null };

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const qData = urlParams.get('q');
            if (qData) {
                try {
                    const jsonStr = LZString.decompressFromEncodedURIComponent(qData);
                    if (jsonStr) questionBank = JSON.parse(jsonStr);
                } catch (e) { console.error(e); }
            }
            renderForm();
        };

        // --- è€å¸«å¾Œå°ï¼šå‹•æ…‹è¡¨å–®æ¸²æŸ“ ---
        function renderForm() {
            const container = document.getElementById('form-container');
            container.innerHTML = "";
            
            levelRewards.forEach((reward, index) => {
                const level = index + 1;
                const questions = questionBank[level] || [];
                
                const section = document.createElement('div');
                section.className = 'level-section collapsed'; // é è¨­æ”¶åˆ
                section.id = `level-section-${level}`;
                
                const header = document.createElement('div');
                header.className = 'level-title';
                header.onclick = () => toggleLevelSection(level);
                header.innerHTML = `<h3>ç¬¬ ${level} é—œï¼š${reward.name} <span style="font-size:0.8em; color:#666">(${questions.length} é¡Œ)</span></h3> <span class="toggle-icon">â–¼</span>`;
                
                const qContainer = document.createElement('div');
                qContainer.className = 'questions-container';
                qContainer.id = `q-container-${level}`;

                // æ¸²æŸ“ç¾æœ‰é¡Œç›®
                questions.forEach((q, qIndex) => {
                    qContainer.appendChild(createQuestionCard(level, q, qIndex));
                });

                // æ–°å¢é¡Œç›®æŒ‰éˆ•
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-add';
                addBtn.innerText = '+ æ–°å¢é¡Œç›®';
                addBtn.style.marginTop = "10px";
                addBtn.onclick = () => addQuestion(level);
                
                qContainer.appendChild(addBtn);
                section.appendChild(header);
                section.appendChild(qContainer);
                container.appendChild(section);
            });
        }

        function toggleLevelSection(level) {
            const section = document.getElementById(`level-section-${level}`);
            section.classList.toggle('collapsed');
        }

        function createQuestionCard(level, data = {}, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            const type = data.type || 'choice';
            const qVal = data.q || '';
            const aVal = data.a || '';
            // å¦‚æœæ˜¯é¸æ“‡é¡Œï¼Œé¸é …æ˜¯ arrayï¼Œè¦è½‰å­—ä¸²é¡¯ç¤ºã€‚å¦‚æœæ˜¯å¡«ç©ºé¡Œï¼Œé¸é …æ˜¯ç©ºã€‚
            // é€™è£¡ç‚ºäº†æ–¹ä¾¿è€å¸«ç·¨è¼¯ï¼Œæˆ‘å€‘è®“é¸æ“‡é¡Œçš„"é¸é …"æ¬„ä½ï¼Œé è¨­å¸¶å…¥ data.opts (æ’é™¤æ­£ç¢ºç­”æ¡ˆï¼Œæˆ–åŒ…å«æ­£ç¢ºç­”æ¡ˆï¼Œè¦–é‚è¼¯è€Œå®š)
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ä»‹é¢ä¸Šé¡¯ç¤º: [æ­£ç¢ºç­”æ¡ˆ] [éŒ¯èª¤é¸é …1,éŒ¯èª¤é¸é …2...]
            
            let wrongOpts = "";
            if (type === 'choice' && data.opts) {
                // å¾ opts è£¡éæ¿¾æ‰æ­£ç¢ºç­”æ¡ˆï¼Œå‰©ä¸‹çš„å°±æ˜¯éŒ¯èª¤é¸é …
                wrongOpts = data.opts.filter(o => o !== aVal).join(',');
            }

            let html = `
                <div class="question-header">
                    <strong>é¡Œç›® #${index + 1}</strong>
                    <button class="btn-del" onclick="deleteQuestion(${level}, ${index})">åˆªé™¤</button>
                </div>
                <div class="form-row">
                    <select class="form-control" style="width:30%" onchange="changeType(this, ${level}, ${index})">
                        <option value="choice" ${type==='choice'?'selected':''}>é¸æ“‡é¡Œ</option>
                        <option value="input" ${type==='input'?'selected':''}>å¡«ç©ºé¡Œ</option>
                    </select>
                    <input type="text" class="form-control" placeholder="è¼¸å…¥é¡Œç›® (ä¾‹å¦‚: 2 x 9 = ?)" value="${qVal}" onchange="updateQData(${level}, ${index}, 'q', this.value)">
                </div>
                <div class="form-row">
                    <input type="text" class="form-control" placeholder="æ­£ç¢ºç­”æ¡ˆ (ä¾‹å¦‚: 18)" value="${aVal}" style="border-color: #2e7d32; background:#e8f5e9;" onchange="updateQData(${level}, ${index}, 'a', this.value)">
                </div>
                <div class="form-row choice-only" style="display: ${type==='choice'?'flex':'none'}">
                    <input type="text" class="form-control" placeholder="éŒ¯èª¤é¸é … (ç”¨é€—è™Ÿåˆ†é–‹ï¼Œä¾‹å¦‚: 16, 20)" value="${wrongOpts}" onchange="updateQData(${level}, ${index}, 'wrong', this.value)">
                </div>
            `;
            card.innerHTML = html;
            return card;
        }

        function addQuestion(level) {
            if (!questionBank[level]) questionBank[level] = [];
            // é è¨­æ–°å¢ä¸€é¡Œç©ºçš„é¸æ“‡é¡Œ
            questionBank[level].push({ q: "", a: "", type: "choice", opts: [] });
            renderForm();
            // è‡ªå‹•å±•é–‹è©²å±¤
            document.getElementById(`level-section-${level}`).classList.remove('collapsed');
        }

        function deleteQuestion(level, index) {
            if (confirm("ç¢ºå®šè¦åˆªé™¤é€™é¡Œå—ï¼Ÿ")) {
                questionBank[level].splice(index, 1);
                renderForm();
                document.getElementById(`level-section-${level}`).classList.remove('collapsed');
            }
        }

        function changeType(select, level, index) {
            questionBank[level][index].type = select.value;
            renderForm(); // é‡ç¹ªä»¥é¡¯ç¤º/éš±è—éŒ¯èª¤é¸é …æ¬„ä½
            document.getElementById(`level-section-${level}`).classList.remove('collapsed');
        }

        function updateQData(level, index, field, value) {
            const qData = questionBank[level][index];
            if (field === 'q') qData.q = value;
            if (field === 'a') qData.a = value;
            if (field === 'wrong') {
                // ç•¶ç·¨è¼¯éŒ¯èª¤é¸é …æ™‚ï¼Œæˆ‘å€‘é‡æ–°çµ„åˆ opts é™£åˆ— (æ­£ç¢ºç­”æ¡ˆ + éŒ¯èª¤é¸é …)
                const wrongs = value.split(',').map(s => s.trim()).filter(s => s !== "");
                // é€™è£¡æš«å­˜éŒ¯èª¤é¸é …å­—ä¸²ä¾› UI é¡¯ç¤ºï¼Œå¯¦éš›é‚è¼¯åœ¨ generate æ™‚è™•ç†ï¼Œæˆ–è€…å³æ™‚è™•ç†
                // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘é€™è£¡ä¸ç›´æ¥å­˜ wrongsï¼Œè€Œæ˜¯ç•¶ä¸‹æ··åˆã€‚
                // ä½†ç‚ºäº†ä¸‹æ¬¡ render æ­£ç¢ºï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹åœ°æ–¹å­˜ wrongOptsã€‚
                // ä¿®æ­£ï¼šç›´æ¥æ›´æ–° optsã€‚Opts = [æ­£ç¢ºç­”æ¡ˆ, ...éŒ¯èª¤é¸é …]
                qData.opts = [qData.a, ...wrongs];
            }
            // å¦‚æœæ˜¯æ›´æ–°æ­£ç¢ºç­”æ¡ˆï¼Œä¹Ÿè¦åŒæ­¥æ›´æ–° opts çš„ç¬¬ä¸€å€‹å…ƒç´ (å¦‚æœæ˜¯é¸æ“‡é¡Œ)
            if (field === 'a' && qData.type === 'choice') {
                 // é€™è£¡æ¯”è¼ƒè¤‡é›œï¼Œç°¡å–®ä½œæ³•ï¼šä¿ç•™åŸæœ¬çš„éŒ¯èª¤é¸é …ï¼Œæ›´æ–°æ­£ç¢ºç­”æ¡ˆ
                 const oldOpts = qData.opts || [];
                 const oldCorrect = oldOpts[0];
                 const wrongs = oldOpts.slice(1); 
                 // å¦‚æœåŸæœ¬æ²’è³‡æ–™
                 if (oldOpts.length === 0) qData.opts = [value];
                 else qData.opts = [value, ...wrongs];
            }
        }

        function toggleTeacherPanel() {
            const panel = document.getElementById('teacher-panel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                renderForm(); // ç¢ºä¿æ‰“é–‹æ™‚æ˜¯æœ€æ–°çš„
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function generateShareLink() {
            // æ•´ç†è³‡æ–™ï¼šç§»é™¤ç©ºé¡Œç›®ï¼Œç¢ºä¿ opts å®Œæ•´
            let outputObj = {};
            for(let i=1; i<=9; i++) {
                const qs = questionBank[i];
                if (qs && qs.length > 0) {
                    // éæ¿¾æ‰é¡Œç›®æˆ–ç­”æ¡ˆæ˜¯ç©ºçš„
                    const validQs = qs.filter(q => q.q.trim() !== "" && q.a.trim() !== "");
                    if (validQs.length > 0) {
                        outputObj[i] = validQs;
                    }
                }
            }

            const jsonStr = JSON.stringify(outputObj);
            const compressed = LZString.compressToEncodedURIComponent(jsonStr);
            const finalUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + "?q=" + compressed;
            document.getElementById('share-url').value = finalUrl;
            document.getElementById('link-result').style.display = 'block';
        }

        function copyLink() {
            const copyText = document.getElementById("share-url");
            copyText.select();
            document.execCommand("copy");
            alert("é€£çµå·²è¤‡è£½ï¼");
        }

        function testLink() {
            window.location.href = document.getElementById("share-url").value;
        }

        // --- éŠæˆ²é‚è¼¯ ---
        const sidebarAvatar = document.getElementById('current-avatar');
        const sidebarName = document.getElementById('player-name');
        const sidebarLevel = document.getElementById('current-level');
        const sidebarScore = document.getElementById('current-score');
        const startScreen = document.getElementById('start-screen');
        const quizArea = document.getElementById('quiz-area');
        const winScreen = document.getElementById('win-screen');
        const questionText = document.getElementById('q-text');
        const optionsArea = document.getElementById('options-area');
        const feedbackMessage = document.getElementById('feedback-message');
        const rewardImg = document.getElementById('reward-img');
        const rewardName = document.getElementById('reward-name');
        const rewardContainer = document.getElementById('reward-container');

        function initAudio() { if (!gameState.audioCtx && (window.AudioContext || window.webkitAudioContext)) gameState.audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
        function playMagicSound() {
            if (!gameState.audioCtx) return;
            if (gameState.audioCtx.state === 'suspended') gameState.audioCtx.resume();
            const ctx = gameState.audioCtx, now = ctx.currentTime;
            [523.25, 659.25, 783.99, 1046.50, 1318.51, 1567.98].forEach((freq, i) => {
                const osc = ctx.createOscillator(), gain = ctx.createGain();
                osc.type = 'sine'; osc.frequency.setValueAtTime(freq, now + i*0.1);
                gain.gain.setValueAtTime(0.05, now + i*0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.8);
                osc.connect(gain); gain.connect(ctx.destination);
                osc.start(now + i*0.1); osc.stop(now + i*0.1 + 0.8);
            });
        }

        function startGame(name, avatarPath) {
            initAudio(); gameState.playerName = name; sidebarAvatar.src = avatarPath; sidebarName.textContent = gameState.playerName;
            startScreen.style.display = 'none'; quizArea.style.display = 'flex'; loadLevel(1);
        }

        function loadLevel(level) {
            gameState.level = level; gameState.currentQuestionIndex = 0; sidebarLevel.textContent = level;
            document.getElementById('level-title').textContent = `é—œå¡ ${level} - ç›®æ¨™ï¼š${levelRewards[level-1] ? levelRewards[level-1].name : "???"}`;
            document.getElementById('target-reward').textContent = `ç›®æ¨™ï¼š${levelRewards[level-1] ? levelRewards[level-1].name : "???"}`;
            
            let rawQuestions = questionBank[level];
            if(!rawQuestions || rawQuestions.length === 0) {
                // å¦‚æœæ²’æœ‰é¡Œç›®ï¼Œçµ¦ä¸€å€‹é è¨­é€šé—œé¡Œ
                gameState.questionsInCurrentLevel = [{q: "æœ¬é—œå¡é€šé", a: "Pass", type: "input"}];
            } else {
                // è¤‡è£½ä¸¦æ‰“äº‚é¡Œç›®é †åº
                gameState.questionsInCurrentLevel = shuffleArray(JSON.parse(JSON.stringify(rawQuestions)));
            }
            if(gameState.questionsInCurrentLevel.length > 10) gameState.questionsInCurrentLevel = gameState.questionsInCurrentLevel.slice(0, 10);
            loadNextQuestion();
        }

        function loadNextQuestion() {
            feedbackMessage.textContent = ''; optionsArea.innerHTML = ''; 
            if (gameState.currentQuestionIndex >= gameState.questionsInCurrentLevel.length) { levelComplete(); return; }
            
            const currentQ = gameState.questionsInCurrentLevel[gameState.currentQuestionIndex];
            
            // è™•ç†å¡«ç©ºåº•ç·š
            let displayText = currentQ.q.replace(/_____/g, '<span style="border-bottom: 3px solid var(--primary-color); display:inline-block; width:80px;">&nbsp;</span>');
            
            // æ™ºæ…§è£œå…¨ "? " (å¦‚æœé¡Œç›®æ²’æœ‰å•è™Ÿä¸”æ˜¯é¸æ“‡é¡Œæˆ–å¡«ç©ºé¡Œ)
            if (!displayText.includes('?') && !displayText.includes('=')) {
                 displayText += " = ?";
            } else if (!displayText.includes('?')) {
                 displayText += " ?";
            }
            
            questionText.innerHTML = displayText;

            if (currentQ.type === 'choice') {
                optionsArea.className = 'options-grid'; optionsArea.style.display = 'grid';
                // ç¢ºä¿é¸é …åŒ…å«æ­£ç¢ºç­”æ¡ˆï¼Œä¸¦ä¸”æ‰“äº‚
                let opts = currentQ.opts || [];
                // å¦‚æœ opts è£¡é¢æ²’æœ‰æ­£ç¢ºç­”æ¡ˆ (é˜²å‘†)ï¼ŒæŠŠæ­£ç¢ºç­”æ¡ˆåŠ é€²å»
                if (!opts.includes(currentQ.a)) opts.push(currentQ.a);
                opts = shuffleArray(opts);

                opts.forEach(option => {
                    const btn = document.createElement('button'); btn.className = 'option-btn'; btn.textContent = option;
                    btn.onclick = () => checkAnswer(option, currentQ.a); optionsArea.appendChild(btn);
                });
            } else {
                // å¡«ç©ºé¡Œ
                optionsArea.className = ''; optionsArea.style.display = 'flex'; optionsArea.style.flexDirection = 'column'; optionsArea.style.alignItems = 'center';
                if(currentQ.a === "Pass") {
                    const btn = document.createElement('button'); btn.className = 'action-btn'; btn.textContent = 'é ˜å–çå‹µ'; btn.onclick = () => checkAnswer("Pass", "Pass"); optionsArea.appendChild(btn);
                } else {
                    const input = document.createElement('input'); input.type = 'text'; input.className = 'input-answer'; input.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆ...'; input.id = 'answer-input';
                    input.onkeypress = (e) => { if(e.key === 'Enter') checkAnswer(input.value.trim(), currentQ.a); };
                    const submitBtn = document.createElement('button'); submitBtn.className = 'action-btn'; submitBtn.textContent = 'ç¢ºèª'; submitBtn.style.marginTop = '20px';
                    submitBtn.onclick = () => checkAnswer(input.value.trim(), currentQ.a);
                    optionsArea.appendChild(input); optionsArea.appendChild(submitBtn); input.focus();
                }
            }
        }

        function checkAnswer(userAnswer, correctAnswer) {
            if(!userAnswer && userAnswer !== 0) return;
            const buttons = optionsArea.querySelectorAll('button'); buttons.forEach(btn => btn.disabled = true);
            if(document.getElementById('answer-input')) document.getElementById('answer-input').disabled = true;

            // é—œéµä¿®æ­£ï¼šè½‰å­—ä¸²ã€å»ç©ºç™½ã€è½‰å°å¯«ï¼Œç¢ºä¿ "18" å’Œ "18 " ä¸€æ¨£
            const cleanUser = String(userAnswer).trim().toLowerCase();
            const cleanCorrect = String(correctAnswer).trim().toLowerCase();

            if ((cleanUser === cleanCorrect) || (correctAnswer === "Pass")) {
                feedbackMessage.innerHTML = "âœ¨ æ–½å’’æˆåŠŸï¼ç­”å°äº†ï¼ âœ¨"; feedbackMessage.style.color = "green"; playMagicSound();
                if(correctAnswer !== "Pass") { gameState.score += 10; sidebarScore.textContent = gameState.score; }
                setTimeout(() => { gameState.currentQuestionIndex++; loadNextQuestion(); }, 1000);
            } else {
                feedbackMessage.innerHTML = "ğŸ’¥ å’’èªåå½ˆï¼å†è©¦ä¸€æ¬¡ã€‚"; feedbackMessage.style.color = "#d32f2f";
                setTimeout(() => { buttons.forEach(btn => btn.disabled = false); if(document.getElementById('answer-input')) { document.getElementById('answer-input').disabled = false; document.getElementById('answer-input').focus(); } feedbackMessage.textContent = ''; }, 1500);
            }
        }

        function levelComplete() {
            quizArea.style.display = 'none'; winScreen.style.display = 'flex';
            const reward = levelRewards[gameState.level - 1];
            if (reward) { rewardImg.src = reward.img; rewardName.textContent = reward.name; playMagicSound(); createStars(); }
        }

        function nextLevel() {
            winScreen.style.display = 'none';
            if (gameState.level < 9) { quizArea.style.display = 'flex'; loadLevel(gameState.level + 1); }
            else { alert(`æ­å–œ ${gameState.playerName}ï¼ä½ å·²é€šéæ‰€æœ‰è€ƒé©—ï¼Œç¸½åˆ†ï¼š${gameState.score}`); location.href = window.location.href.split('?')[0]; }
        }

        function createStars() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    const star = document.createElement('div'); star.className = 'magic-star';
                    star.textContent = ['âœ¨', 'â­', 'ğŸ’«'][Math.floor(Math.random() * 3)]; star.style.color = ['gold', '#ffd700', '#fff'][Math.floor(Math.random() * 3)];
                    const startX = (Math.random() - 0.5) * 100; const startY = (Math.random() - 0.5) * 100;
                    const tx = (Math.random() - 0.5) * 800; const ty = (Math.random() - 0.5) * 800;
                    star.style.left = `calc(50% + ${startX}px)`; star.style.top = `calc(50% + ${startY}px)`;
                    star.style.setProperty('--tx', `${tx}px`); star.style.setProperty('--ty', `${ty}px`);
                    rewardContainer.appendChild(star); setTimeout(() => star.remove(), 1000);
                }, i * 50);
            }
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    </script>
</body>
</html>
