<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœæ ¼è¯èŒ²é­”æ³•æŒ‘æˆ°</title>
    <style>
        /* --- è¦–è¦ºæ¨£å¼è¨­å®š --- */
        :root {
            --primary-color: #4a3f35; /* æ·±ç¾Šçš®ç´™è‰² */
            --secondary-color: #f8e7b9; /* äº®ç¾Šçš®ç´™è‰² */
            --accent-color: #740001; /* è‘›ä¾†åˆ†å¤šç´… */
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Times New Roman', serif, "å¾®è»Ÿæ­£é»‘é«”";
            margin: 0;
            padding: 0;
            /* ä¿®æ­£ï¼šç§»é™¤ images/ ä¸¦æ”¹æˆå¤§å¯« .PNG */
            background-image: url('bg_hogwarts_transparent.PNG');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-color: #f0f0f0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* å·¦å´é‚Šæ¬„ */
        #sidebar {
            width: var(--sidebar-width);
            background-color: rgba(60, 47, 47, 0.95);
            color: var(--secondary-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            border-right: 3px solid var(--accent-color);
            z-index: 10;
        }

        .avatar-container {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid var(--accent-color);
            overflow: hidden;
            margin-bottom: 20px;
            background-color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        .player-info h2 {
            margin: 10px 0;
            font-size: 1.8em;
            color: #ffd700;
            text-shadow: 1px 1px 2px #000;
        }

        .level-indicator, .score-board {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* ä¸»ç•«é¢å€ */
        #main-content {
            flex: 1;
            padding: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* ç¾Šçš®ç´™å·è»¸å®¹å™¨ */
        .scroll-container {
            background-color: var(--secondary-color);
            width: 85%;
            max-width: 900px;
            min-height: 600px;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 8px solid transparent;
            border-image: url('https://i.imgur.com/wFfkI6G.png') 30 stretch;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        h1.game-title {
            color: var(--primary-color);
            text-align: center;
            font-size: 3em;
            margin-bottom: 40px;
            font-weight: bold;
        }

        /* è§’è‰²é¸æ“‡å¡ç‰‡ */
        #character-selection {
            display: flex;
            gap: 30px;
            justify-content: center;
            width: 100%;
            flex-wrap: wrap;
        }

        .char-card {
            width: 200px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            background: rgba(255,255,255,0.4);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid var(--primary-color);
        }

        .char-card:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.7);
        }

        .char-card img {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .char-card h3 {
            color: var(--primary-color);
            font-size: 1.5em;
            margin: 0;
        }

        /* ç­”é¡Œå€ */
        #quiz-area, #win-screen, #teacher-instruction {
            display: none;
            width: 100%;
            text-align: center;
        }

        .question-text {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-bottom: 40px;
            font-weight: bold;
            line-height: 1.4;
        }

        /* é¸é …æŒ‰éˆ•å€ */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 20px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }

        .option-btn, .action-btn {
            padding: 20px;
            font-size: 1.5em;
            border: 4px solid var(--primary-color);
            background-color: rgba(255,255,255,0.5);
            color: var(--primary-color);
            cursor: pointer;
            border-radius: 12px;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.2s;
        }

        .option-btn:hover, .action-btn:hover {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            transform: scale(1.02);
        }

        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .input-answer {
            padding: 15px;
            font-size: 1.8em;
            width: 60%;
            margin-bottom: 20px;
            border: 4px solid var(--primary-color);
            background-color: #fff;
            text-align: center;
            border-radius: 10px;
        }

        #feedback-message {
            min-height: 40px;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 15px;
        }

        /* ç²å‹ç•«é¢èˆ‡çå‹µåœ– */
        .reward-image-container {
            position: relative;
            width: 60%;
            height: 350px;
            margin: 10px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .reward-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 20px gold);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        /* é­”æ³•æ˜Ÿæ˜Ÿç‰¹æ•ˆ */
        .magic-star {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: magic-swoosh 1s ease-out forwards;
            opacity: 0;
            z-index: 20;
        }

        @keyframes magic-swoosh {
            0% { opacity: 1; transform: translate(0, 0) scale(0.5) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(1.5) rotate(180deg); }
        }

        /* è€å¸«èªªæ˜æŒ‰éˆ• */
        .instruction-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.6);
            border: 2px solid var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: var(--primary-color);
            z-index: 5;
        }
        
        .instruction-content {
            text-align: left;
            font-size: 1.2em;
            line-height: 1.8;
            max-height: 500px;
            overflow-y: auto;
            padding: 30px;
            background: rgba(255,255,255,0.4);
            border-radius: 10px;
        }
        .instruction-content code {
            background-color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            color: #d32f2f;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="avatar-container">
            <img id="current-avatar" src="https://via.placeholder.com/140x140?text=?" alt="è§’è‰²">
        </div>
        <div class="player-info">
            <h2 id="player-name">è¨ªå®¢</h2>
            <div class="level-indicator">Level <span id="current-level">1</span></div>
            <div class="score-board">åˆ†æ•¸: <span id="current-score">0</span></div>
        </div>
    </div>

    <div id="main-content">
        <button class="instruction-toggle" onclick="toggleInstructions()">çµ¦è€å¸«çš„å‡ºé¡Œèªªæ˜</button>

        <div class="scroll-container">
            
            <div id="start-screen">
                <h1 class="game-title">é¸æ“‡ä½ çš„å·«å¸«å¤¥ä¼´</h1>
                <div id="character-selection">
                    <div class="char-card" onclick="startGame('å“ˆåˆ©æ³¢ç‰¹', 'harry_selection.PNG')">
                        <img src="harry_selection.PNG" alt="å“ˆåˆ©æ³¢ç‰¹">
                        <h3>å“ˆåˆ©æ³¢ç‰¹</h3>
                    </div>
                    <div class="char-card" onclick="startGame('æ¦®æ©è¡›æ–¯ç†', 'ron_selection.PNG')">
                        <img src="ron_selection.PNG" alt="æ¦®æ©è¡›æ–¯ç†">
                        <h3>æ¦®æ©è¡›æ–¯ç†</h3>
                    </div>
                    <div class="char-card" onclick="startGame('å¦™éº—æ ¼è˜­å‚‘', 'hermione_selection.PNG')">
                        <img src="hermione_selection.PNG" alt="å¦™éº—æ ¼è˜­å‚‘">
                        <h3>å¦™éº—æ ¼è˜­å‚‘</h3>
                    </div>
                </div>
            </div>

            <div id="quiz-area">
                <h2 id="level-title" style="color: var(--accent-color); margin-bottom: 20px;">é—œå¡ 1</h2>
                <div id="question-container">
                    <p class="question-text" id="q-text">é¡Œç›®è¼‰å…¥ä¸­...</p>
                    <div id="options-area" class="options-grid"></div>
                </div>
                <p id="feedback-message"></p>
            </div>

            <div id="win-screen">
                <h2 style="font-size: 2.5em; color: var(--accent-color);">æŒ‘æˆ°æˆåŠŸï¼</h2>
                <p style="font-size: 1.5em;">ç²å¾—é­”æ³•ç‰©å“ï¼š</p>
                
                <div class="reward-image-container" id="reward-container">
                    <img id="reward-img" class="reward-image" src="" alt="çå‹µ">
                </div>
                
                <h3 id="reward-name" style="font-size: 2em; color: var(--primary-color); margin: 10px 0;"></h3>
                <button class="action-btn" onclick="nextLevel()">å‰å¾€ä¸‹ä¸€é—œ</button>
            </div>

             <div id="teacher-instruction">
                <h1 style="color: var(--accent-color);">å‡ºé¡Œå™¨èªªæ˜</h1>
                <div class="instruction-content">
                    <p>è€å¸«æ‚¨å¥½ï¼Œè«‹åœ¨ç¨‹å¼ç¢¼ä¸‹æ–¹çš„ <code>questionBank</code> å€åŸŸä¾ç…§æ ¼å¼è¼¸å…¥é¡Œç›®ã€‚</p>
                    <p><strong>1. å¡«ç©º/ç°¡ç­”é¡Œ (ç„¡é¸é …)</strong><br>
                    æ ¼å¼: <code>"é¡Œç›®=æ­£ç¢ºç­”æ¡ˆ"</code><br>
                    ç¯„ä¾‹: <code>"9x9=?=81"</code></p>
                    
                    <p><strong>2. é¸æ“‡é¡Œ (è‡ªå‹•ç”¢ç”ŸæŒ‰éˆ•)</strong><br>
                    æ ¼å¼: <code>"é¡Œç›®=æ­£ç¢ºé¸é …=éŒ¯èª¤1,éŒ¯èª¤2,éŒ¯èª¤3"</code><br>
                    ç¯„ä¾‹: <code>"è˜‹æœçš„ä¸­æ–‡?=pÃ­ngguÇ’=pÃ­ngguÅ,bÃ­ngguÇ’"</code></p>
                </div>
                <button class="action-btn" onclick="toggleInstructions()">è¿”å›éŠæˆ²</button>
            </div>

        </div>
    </div>

    <script>
        // --- 1. åœ–ç‰‡è·¯å¾‘è¨­å®š (ä¿®æ­£ï¼šç§»é™¤ images/ ä¸¦æ”¹æˆå¤§å¯« .PNG) ---
        const levelRewards = [
            { name: "è¡›æ–¯ç†å®¶çš„é£›è»Š", img: "reward_lv1_fordanglia.PNG" }, // LV 1
            { name: "å…‰è¼ªå…©åƒ",       img: "reward_lv2_nimbus2000.PNG" },  // LV 2
            { name: "éš±å½¢æ–—ç¯·",       img: "reward_lv3_cloak.PNG" },       // LV 3
            { name: "åŠ«ç›œåœ°åœ–",       img: "reward_lv4_map.PNG" },         // LV 4
            { name: "é·¹é¦¬",           img: "reward_lv5_hippogriff.PNG" },  // LV 5
            { name: "äººé¦¬",           img: "reward_lv6_centaur.PNG" },     // LV 6
            { name: "ç¨è§’ç¸",         img: "reward_lv7_unicorn.PNG" },     // LV 7
            { name: "å®¶åº­å°ç²¾éˆ(å¤šæ¯”)", img: "reward_lv8_dobby.PNG" },      // LV 8
            { name: "é³³å‡°",           img: "reward_lv9_phoenix.PNG" }      // LV 9
        ];

        // --- 2. é¡Œåº«å€ (è«‹è€å¸«åœ¨é€™è£¡ä¿®æ”¹é¡Œç›®) ---
        const questionBank = {
            1: [ 
                "2 x 3 = ?=6",
                "å“ˆåˆ©æ³¢ç‰¹çš„è²“é ­é·¹å«ä»€éº¼åå­—ï¼Ÿ=é»‘ç¾=æ–‘æ–‘,é˜¿è¾£å“¥",
                "ä¸­æ–‡æ‹¼éŸ³: å­¸æ ¡=xuÃ©xiÃ o=xÃ¼Ã©xiÃ o,xuÃ©xiao"
            ],
            2: [ 
                "5 x 5 = ?=25",
                "9 x 9 = ?=81",
                "æ¦®æ©æœ‰å¹¾å€‹å“¥å“¥ï¼Ÿ=5å€‹=3å€‹,7å€‹"
            ],
            3: ["3+3=6"],
            4: ["4+4=8"],
            5: ["5+5=10"],
            6: ["6+6=12"],
            7: ["7+7=14"],
            8: ["8+8=16"],
            9: ["9+9=18"]
        };

        // --- 3. éŠæˆ²é‚è¼¯ ---
        let gameState = {
            playerName: "è¨ªå®¢",
            level: 1,
            score: 0,
            currentQuestionIndex: 0,
            questionsInCurrentLevel: [],
            audioCtx: null 
        };

        const sidebarAvatar = document.getElementById('current-avatar');
        const sidebarName = document.getElementById('player-name');
        const sidebarLevel = document.getElementById('current-level');
        const sidebarScore = document.getElementById('current-score');
        const startScreen = document.getElementById('start-screen');
        const quizArea = document.getElementById('quiz-area');
        const winScreen = document.getElementById('win-screen');
        const instructionScreen = document.getElementById('teacher-instruction');
        const questionText = document.getElementById('q-text');
        const optionsArea = document.getElementById('options-area');
        const feedbackMessage = document.getElementById('feedback-message');
        const rewardImg = document.getElementById('reward-img');
        const rewardName = document.getElementById('reward-name');
        const rewardContainer = document.getElementById('reward-container');
        const scrollContainer = document.querySelector('.scroll-container');

        // --- 4. å…§å»ºéŸ³æ•ˆåˆæˆå™¨ (Magic Sound Generator) ---
        function initAudio() {
            if (!gameState.audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    gameState.audioCtx = new AudioContext();
                }
            }
        }

        function playMagicSparkle() {
            if (!gameState.audioCtx) return;
            if (gameState.audioCtx.state === 'suspended') {
                gameState.audioCtx.resume();
            }

            const ctx = gameState.audioCtx;
            const now = ctx.currentTime;
            const tones = [880, 1109, 1318, 1760, 2093]; 

            tones.forEach((freq, index) => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq;

                const startTime = now + (index * 0.05);
                const duration = 0.5;

                gain.gain.setValueAtTime(0.05, startTime);
                gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start(startTime);
                osc.stop(startTime + duration);
            });
        }

        // --- 5. æµç¨‹æ§åˆ¶ ---

        function startGame(name, avatarPath) {
            initAudio();
            gameState.playerName = name;
            sidebarAvatar.src = avatarPath;
            sidebarName.textContent = gameState.playerName;
            
            startScreen.style.display = 'none';
            quizArea.style.display = 'block';
            scrollContainer.style.justifyContent = 'flex-start';
            loadLevel(1);
        }

        function loadLevel(level) {
            gameState.level = level;
            gameState.currentQuestionIndex = 0;
            sidebarLevel.textContent = level;
            
            const rewardNameText = levelRewards[level-1] ? levelRewards[level-1].name : "";
            document.getElementById('level-title').textContent = `é—œå¡ ${level}ï¼šç›®æ¨™ - ${rewardNameText}`;

            const rawQuestions = questionBank[level] || ["æœ¬é—œå¡é€šéï¼=Pass"];
            gameState.questionsInCurrentLevel = rawQuestions.map(parseQuestionStr);
            loadNextQuestion();
        }

        function parseQuestionStr(qStr) {
            const parts = qStr.split('=');
            const qText = parts[0];
            const correctAnswer = parts[1];
            let type = 'input'; 
            let options = [];

            if (parts.length > 2 && parts[2].trim() !== "") {
                type = 'choice';
                const wrongAnswers = parts[2].split(',');
                options = [correctAnswer, ...wrongAnswers];
                options = shuffleArray(options);
            }
            return { text: qText, correct: correctAnswer, type: type, options: options };
        }

        function loadNextQuestion() {
            feedbackMessage.textContent = '';
            optionsArea.innerHTML = ''; 

            if (gameState.currentQuestionIndex >= gameState.questionsInCurrentLevel.length) {
                levelComplete();
                return;
            }

            const currentQ = gameState.questionsInCurrentLevel[gameState.currentQuestionIndex];
            questionText.innerHTML = currentQ.text.replace(/___/g, '<span style="text-decoration: underline; margin: 0 5px;">____</span>');

            if (currentQ.type === 'choice') {
                optionsArea.className = 'options-grid';
                optionsArea.style.display = 'grid';
                currentQ.options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = option;
                    btn.onclick = () => checkAnswer(option, currentQ.correct);
                    optionsArea.appendChild(btn);
                });
            } else {
                optionsArea.className = '';
                optionsArea.style.display = 'flex';
                optionsArea.style.flexDirection = 'column';
                optionsArea.style.alignItems = 'center';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'input-answer';
                input.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆ';
                input.id = 'answer-input';
                input.addEventListener("keypress", function(event) {
                    if (event.key === "Enter") checkAnswer(input.value.trim(), currentQ.correct);
                });
                
                const submitBtn = document.createElement('button');
                submitBtn.className = 'action-btn';
                submitBtn.textContent = 'ç¢ºèªæ–½å’’';
                submitBtn.style.marginTop = '15px';
                submitBtn.onclick = () => checkAnswer(input.value.trim(), currentQ.correct);

                optionsArea.appendChild(input);
                optionsArea.appendChild(submitBtn);
                input.focus();
            }
        }

        function checkAnswer(userAnswer, correctAnswer) {
            if(!userAnswer) return;
            const buttons = optionsArea.querySelectorAll('button');
            buttons.forEach(btn => btn.disabled = true);
            if(document.getElementById('answer-input')) document.getElementById('answer-input').disabled = true;

            if (userAnswer.toLowerCase() === correctAnswer.toLowerCase() || userAnswer === "Pass") {
                feedbackMessage.innerHTML = "âœ¨ æ–½å’’æˆåŠŸï¼ç­”å°äº†ï¼ âœ¨";
                feedbackMessage.style.color = "green";
                if(userAnswer !== "Pass") gameState.score += 10;
                sidebarScore.textContent = gameState.score;
                setTimeout(() => {
                    gameState.currentQuestionIndex++;
                    loadNextQuestion();
                }, 1000);
            } else {
                feedbackMessage.textContent = `ğŸ’¥ å’’èªå¤±æ•—ï¼å†è©¦ä¸€æ¬¡ã€‚`;
                feedbackMessage.style.color = "#d32f2f";
                setTimeout(() => {
                     buttons.forEach(btn => btn.disabled = false);
                     if(document.getElementById('answer-input')) {
                         document.getElementById('answer-input').disabled = false;
                         document.getElementById('answer-input').focus();
                     }
                     feedbackMessage.textContent = '';
                }, 1500);
            }
        }

        function levelComplete() {
            quizArea.style.display = 'none';
            winScreen.style.display = 'block';
            scrollContainer.style.justifyContent = 'center';

            const rewardIndex = gameState.level - 1;
            if (rewardIndex < levelRewards.length) {
                const reward = levelRewards[rewardIndex];
                rewardImg.src = reward.img;
                rewardName.textContent = reward.name;
                triggerMagicEffect(); 
            }
        }

        function nextLevel() {
            winScreen.style.display = 'none';
            if (gameState.level < 9) {
                quizArea.style.display = 'block';
                scrollContainer.style.justifyContent = 'flex-start';
                loadLevel(gameState.level + 1);
            } else {
                alert(`æ­å–œ ${gameState.playerName}ï¼ä½ å·²é€šéæ‰€æœ‰éœæ ¼è¯èŒ²çš„è€ƒé©—ï¼`);
                location.reload();
            }
        }

        function triggerMagicEffect() {
            playMagicSparkle();
            for (let i = 0; i < 20; i++) {
                setTimeout(createStar, i * 100);
            }
        }

        function createStar() {
            const star = document.createElement('div');
            star.className = 'magic-star';
            star.textContent = ['âœ¨', 'â­', 'ğŸ’«'][Math.floor(Math.random() * 3)];
            star.style.color = ['gold', '#ffd700', '#fff'][Math.floor(Math.random() * 3)];
            
            const startX = (Math.random() - 0.5) * 50;
            const startY = (Math.random() - 0.5) * 50;
            const tx = (Math.random() - 0.5) * 600;
            const ty = (Math.random() - 0.5) * 600;

            star.style.left = `calc(50% + ${startX}px)`;
            star.style.top = `calc(50% + ${startY}px)`;
            star.style.setProperty('--tx', `${tx}px`);
            star.style.setProperty('--ty', `${ty}px`);

            rewardContainer.appendChild(star);
            setTimeout(() => star.remove(), 1000);
        }

        function toggleInstructions() {
            const isShowingInstruction = instructionScreen.style.display === 'block';
            if (isShowingInstruction) {
                instructionScreen.style.display = 'none';
                if (winScreen.style.display === 'block') {
                    
                } else if (gameState.playerName === "è¨ªå®¢") {
                    startScreen.style.display = 'block';
                    scrollContainer.style.justifyContent = 'center';
                } else {
                    quizArea.style.display = 'block';
                    scrollContainer.style.justifyContent = 'flex-start';
                }
            } else {
                startScreen.style.display = 'none';
                quizArea.style.display = 'none';
                instructionScreen.style.display = 'block';
                scrollContainer.style.justifyContent = 'center';
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
